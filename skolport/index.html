<!DOCTYPE html>
<html lang="sv">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Splink-kort</title>
  <style>
    :root {
      --bg: #0b0f14;
      --card: #121821;
      --card-hover: #1a2230;
      --text: #e8eef6;
      --muted: #9fb1c6;
      --accent: #4da3ff;
      --shadow: 0 10px 25px rgba(0,0,0,.35);
      --radius: 16px;
    }

    html, body {
      height: 100%;
      margin: 0;
      background: radial-gradient(1200px 600px at 80% -10%, #0d1520 0%, var(--bg) 60%);
      color: var(--text);
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial;
      -webkit-font-smoothing: antialiased;
      text-rendering: optimizeLegibility;
    }

    header { max-width: 1200px; margin: 24px auto 8px; padding: 0 16px; display: flex; align-items: center; justify-content: space-between; gap: 12px; }
    h1 { font-size: clamp(20px, 2.5vw, 28px); margin: 0; letter-spacing: .2px; }

    .btn { appearance: none; border: none; background: linear-gradient(180deg, #1f2937, #111827); color: var(--text); padding: 10px 14px; border-radius: 10px; cursor: pointer; box-shadow: var(--shadow); transition: transform .12s ease, background .2s ease, opacity .2s ease; }
    .btn:hover { transform: translateY(-1px); opacity: 0.95; }

    main { max-width: 1200px; margin: 0 auto 60px; padding: 0 16px; }

    .grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(220px, 1fr)); gap: 18px; margin-top: 16px; }
    .card { display: flex; flex-direction: column; background: linear-gradient(180deg, var(--card), #0f141c); border: 1px solid rgba(255,255,255,0.06); border-radius: var(--radius); overflow: hidden; text-decoration: none; color: inherit; box-shadow: var(--shadow); transition: transform .16s ease, box-shadow .16s ease, background .2s ease; }
    .card:hover { transform: translateY(-2px); background: var(--card-hover); }
    .card:active { transform: translateY(0); }
    .media { position: relative; width: 100%; aspect-ratio: 16 / 9; background: #0b0f14; overflow: hidden; }
    .media img { width: 100%; height: 100%; object-fit: cover; display: block; }
    .content { padding: 14px 14px 16px; display: grid; gap: 8px; }
    .title { font-size: 1.05rem; line-height: 1.25; font-weight: 700; letter-spacing: .2px; }
    .desc { font-size: .9rem; color: var(--muted); line-height: 1.35; margin: 0; }
    .muted { color: var(--muted); }
    .status { margin-top: 10px; font-size: .9rem; }

    .skeleton { background: linear-gradient(90deg, rgba(255,255,255,.06), rgba(255,255,255,.02), rgba(255,255,255,.06)); background-size: 200% 100%; animation: shimmer 1.2s infinite; border-radius: 12px; height: 160px; }
    @keyframes shimmer { 0% { background-position: 0 0; } 100% { background-position: -200% 0; } }

    /* IDP-väljare */
    .idp-panel{max-width:800px;margin:24px auto 8px;padding:0 16px}
    .idp-list{list-style:none;margin:12px 0 0;padding:0;display:grid;grid-template-columns:repeat(auto-fit,minmax(260px,1fr));gap:10px}
    .idp-item{display:flex;align-items:center;gap:10px;background:linear-gradient(180deg,var(--card),#0f141c);border:1px solid rgba(255,255,255,.06);border-radius:12px;padding:10px;cursor:pointer;box-shadow:var(--shadow);transition:transform .12s ease,background .2s ease}
    .idp-item:hover{transform:translateY(-1px);background:var(--card-hover)}
    .idp-item:focus{outline:2px solid var(--accent);outline-offset:2px}
    .idp-thumb{width:36px;height:36px;border-radius:8px;object-fit:contain;background:#fff;display:block}
    .idp-name{font-weight:600}
      /* IDP-väljare + sök + vald chip */
    .chosen{display:flex;align-items:center;gap:8px;flex-wrap:wrap}
    .chosen .muted{font-size:.9rem}
    .idp-toolbar{margin-top:8px;display:flex;gap:8px;align-items:center}
    #idp-search{flex:1;min-width:220px;padding:8px 10px;border-radius:10px;border:1px solid rgba(255,255,255,.12);background:#0f141c;color:var(--text)}
    .idp-item.selected{outline:2px solid var(--accent)}
    .idp-check{margin-left:auto;color:var(--accent);font-weight:700}
      .chosen-logo{width:20px;height:20px;border-radius:4px;object-fit:contain;background:#fff;box-shadow:var(--shadow)}
  </style>
</head>
<body>
  <header>
    <h1>Splink-kort</h1>
    <button id="reload" class="btn" type="button">Ladda om</button>
  </header>
  <main>
    <section id="idp-panel" class="idp-panel" aria-labelledby="idp-heading">
      <h2 id="idp-heading" class="muted" style="margin:0">Välj identitetsutfärdare</h2>
      <div id="idp-status" class="status muted" style="margin-top:6px">Laddar IDP-lista…</div>
      <ul id="idp-list" class="idp-list" aria-live="polite" aria-busy="true"></ul>
    </section>

    <div id="status" class="status muted" hidden>Välj en IDP ovan.</div>
    <div id="cards" class="grid" aria-live="polite" aria-busy="true" hidden></div>
  </main>

  <template id="card-template">
    <a class="card" href="#" target="_blank" rel="noopener noreferrer" role="button">
      <div class="media"><img alt="" loading="lazy" /></div>
      <div class="content">
        <div class="title"></div>
        <p class="desc"></p>
      </div>
    </a>
  </template>

  <script>
  const DATA_URL = "https://fedfeeds.robertsundin.se/sp/json/splink.json";
  const IDP_URL  = "https://fedfeeds.robertsundin.se/idp/json/multiidp.json";

  const $ = (s) => document.querySelector(s);
  function setStatus(msg, busy = false) {
    const el = $("#status");
    el.textContent = msg;
    if (busy) { el.hidden = false; el.setAttribute('aria-busy', 'true'); } else { el.removeAttribute('aria-busy'); }
  }
  function normalizeItems(payload, keys = { items: 'items', value: 'value' }) {
    if (!payload) return [];
    if (Array.isArray(payload)) return payload;
    if (typeof payload === 'object') {
      if (Array.isArray(payload[keys.items])) return payload[keys.items];
      if (Array.isArray(payload[keys.value])) return payload[keys.value];
      const values = Object.values(payload);
      if (values.length && values.every(v => typeof v === 'object')) return values;
    }
    return [];
  }
  function initialsOf(name) {
    if (!name) return "?";
    return name.toString().trim().split(' ').filter(Boolean).slice(0,2).map(s => s[0]).join('').toUpperCase();
  }

  let selectedIdp = null; // { idpEntityId, idpDisplayName, idpImg }
  let idpItems = [];
  let idpSearchEl = null;
  const STORAGE_KEY = 'splink.selectedIdp';
  function saveSelectedIdp(item){ try{ localStorage.setItem(STORAGE_KEY, JSON.stringify({ idpEntityId: item?.idpEntityId || '', idpDisplayName: item?.idpDisplayName || '', idpImg: item?.idpImg || '' })); }catch(e){} }
  function getSavedIdp(){ try{ const v = localStorage.getItem(STORAGE_KEY); return v ? JSON.parse(v) : null; }catch(e){ return null; } }


  function createToolbarIfNeeded() {
    if (idpSearchEl) return;
    const statusEl = document.getElementById('idp-status');
    if (!statusEl) return;
    const toolbar = document.createElement('div');
    toolbar.className = 'idp-toolbar';
    const input = document.createElement('input');
    input.type = 'search';
    input.id = 'idp-search';
    input.placeholder = 'Sök IDP…';
    toolbar.appendChild(input);
    statusEl.insertAdjacentElement('afterend', toolbar);
    idpSearchEl = input;
    idpSearchEl.addEventListener('input', () => renderIdpList(idpItems));
  }

  function ensureChosenHeader() {
    if (document.getElementById('chosen-idp')) return;
    const header = document.querySelector('header');
    const reloadBtn = document.getElementById('reload');
    const chosen = document.createElement('div');
    chosen.id = 'chosen-idp';
    chosen.className = 'chosen';
    chosen.hidden = true;
    chosen.innerHTML = '<img id="chosen-logo" class="chosen-logo" alt=""> <span class="muted">Vald IDP:</span> <strong id="chosen-name"></strong> <span aria-hidden="true">✓</span> <button id="change-idp" class="btn" type="button">Byt IDP</button>';
    header.insertBefore(chosen, reloadBtn);
    document.getElementById('change-idp').addEventListener('click', () => {
      document.getElementById('idp-panel').style.display = '';
      document.getElementById('cards').hidden = true;
      document.getElementById('status').hidden = true;
      if (idpSearchEl) idpSearchEl.value = '';
      renderIdpList(idpItems);
    });
  }
  function updateChosenHeader(item){
    const chosen = document.getElementById('chosen-idp');
    const chosenName = document.getElementById('chosen-name');
    const logoEl = document.getElementById('chosen-logo');
    if (!chosen || !chosenName || !logoEl) return;
    chosenName.textContent = item?.idpDisplayName || '(utan namn)';
    const src = (item?.idpImg || '').trim();
    if (src){ logoEl.src = src; logoEl.alt = item?.idpDisplayName || ''; logoEl.style.display = ''; }
    else { logoEl.removeAttribute('src'); logoEl.alt = ''; logoEl.style.display = 'none'; }
    chosen.hidden = false;
  }

  // === IDP-väljare ===
  async function loadIdps() {
    const listEl = $('#idp-list');
    const statusEl = $('#idp-status');
    listEl.innerHTML = '';
    statusEl.textContent = 'Laddar IDP-lista…';
    try {
      const res = await fetch(IDP_URL, { cache: 'no-store' });
      if (!res.ok) throw new Error('HTTP ' + res.status);
      const payload = await res.json();
      idpItems = normalizeItems(payload);
      if (!idpItems.length) { statusEl.textContent = 'Hittade inga IDP:er.'; return; }
      statusEl.textContent = 'Välj en IDP:';
      createToolbarIfNeeded();
      renderIdpList(idpItems);
    } catch (err) {
      console.error(err);
      statusEl.textContent = 'Kunde inte läsa in IDP-listan.';
    }
  }

  function renderIdpList(items) {
    const listEl = $('#idp-list');
    listEl.setAttribute('aria-busy', 'false');
    listEl.innerHTML = '';

    let list = Array.isArray(items) ? items.slice() : [];
    const q = (idpSearchEl && idpSearchEl.value ? idpSearchEl.value : '').toLowerCase().trim();
    if (q) list = list.filter(it => (it.idpDisplayName || '').toLowerCase().includes(q));
    if (selectedIdp && selectedIdp.idpEntityId) {
      list.sort((a,b) => (a.idpEntityId === selectedIdp.idpEntityId ? -1 : (b.idpEntityId === selectedIdp.idpEntityId ? 1 : 0)));
    }

    const frag = document.createDocumentFragment();
    for (const item of list) {
      const li = document.createElement('li');
      li.className = 'idp-item';
      li.tabIndex = 0;
      li.role = 'button';
      li.setAttribute('aria-label', 'Välj ' + (item.idpDisplayName || 'IDP'));

      const img = document.createElement('img');
      img.className = 'idp-thumb';
      const src = (item.idpImg || '').trim();
      if (src) img.src = src;
      img.alt = item.idpDisplayName || '';
      img.loading = 'lazy';
      img.onerror = () => {
        const fallback = document.createElement('div');
        fallback.className = 'idp-thumb';
        fallback.style.display = 'grid';
        fallback.style.placeItems = 'center';
        fallback.style.fontWeight = '700';
        fallback.style.background = '#1f2937';
        fallback.textContent = initialsOf(item.idpDisplayName);
        img.replaceWith(fallback);
      };

      const name = document.createElement('div');
      name.className = 'idp-name';
      name.textContent = item.idpDisplayName || '(utan namn)';

      li.appendChild(img);
      li.appendChild(name);

      const isSel = selectedIdp && selectedIdp.idpEntityId && item.idpEntityId === selectedIdp.idpEntityId;
      if (isSel) {
        li.classList.add('selected');
        const check = document.createElement('span');
        check.className = 'idp-check';
        check.textContent = '✓';
        check.setAttribute('aria-hidden','true');
        li.appendChild(check);
      }

      const choose = () => selectIdp(item);
      li.addEventListener('click', choose);
      li.addEventListener('keydown', (ev) => { if (ev.key === 'Enter' || ev.key === ' ') { ev.preventDefault(); choose(); } });

      frag.appendChild(li);
    }
    listEl.appendChild(frag);
  }

  function selectIdp(item) {
    selectedIdp = item || null;
    updateChosenHeader(selectedIdp);
    saveSelectedIdp(selectedIdp);
    document.getElementById('idp-panel').style.display = 'none';
    document.getElementById('cards').hidden = false;
    setStatus('Laddar data…', true);
    loadData();
  }

  // === Kort ===
  function createCard(item) {
    const tpl = document.getElementById('card-template');
    const node = tpl.content.firstElementChild.cloneNode(true);

    const titleEl = node.querySelector('.title');
    const descEl = node.querySelector('.desc');
    const imgEl = node.querySelector('img');

    const displayName = item.spDisplayName ?? '(utan namn)';
    const img = item.spImg || '';
    const base = item.spLink || '';
    const target = item.spTarget || '';
    const idpPart = selectedIdp ? (selectedIdp.idpEntityId || '') : '';

    node.href = '' + base + idpPart + target; // spLink + idpEntityId + spTarget
    node.target = '_blank';
    node.rel = 'noopener noreferrer';
    node.setAttribute('aria-label', 'Öppna: ' + displayName);

    titleEl.textContent = displayName;

    if (item.description) {
      descEl.textContent = item.description;
    } else {
      descEl.remove();
    }

    if (img) {
      imgEl.src = img;
      imgEl.alt = displayName;
    } else {
      node.querySelector('.media').remove();
    }

    return node;
  }

  async function loadData() {
    const cardsEl = $('#cards');
    cardsEl.innerHTML = '';

    for (let i = 0; i < 6; i++) {
      const sk = document.createElement('div');
      sk.className = 'skeleton';
      cardsEl.appendChild(sk);
    }

    try {
      const res = await fetch(DATA_URL, { cache: 'no-store' });
      if (!res.ok) throw new Error('HTTP ' + res.status);
      const payload = await res.json();
      const items = normalizeItems(payload);

      cardsEl.innerHTML = '';
      if (!items.length) { setStatus('Inga kort att visa.'); return; }

      const frag = document.createDocumentFragment();
      for (const item of items) frag.appendChild(createCard(item));
      cardsEl.appendChild(frag);
      setStatus('Visar ' + items.length + ' kort.');
    } catch (err) {
      console.error(err);
      cardsEl.innerHTML = '';
      setStatus('Kunde inte läsa in data. Försök igen.', false);
    }
  }

  document.addEventListener('DOMContentLoaded', () => {
    ensureChosenHeader();
    createToolbarIfNeeded();
    const saved = getSavedIdp();
    if (saved && saved.idpEntityId) {
      selectedIdp = saved;
      updateChosenHeader(saved);
      document.getElementById('idp-panel').style.display = 'none';
      document.getElementById('cards').hidden = false;
      setStatus('Laddar data…', true);
      loadData();
      // Ladda lista i bakgrunden för "Byt IDP"
      loadIdps();
    } else {
      loadIdps();
    }
  }); createToolbarIfNeeded(); loadIdps(); });
  document.getElementById('reload').addEventListener('click', () => {
    if (!selectedIdp) {
      document.getElementById('idp-panel').style.display = '';
      document.getElementById('cards').hidden = true;
      document.getElementById('status').hidden = true;
      loadIdps();
    } else {
      loadData();
    }
  });
</script>
</body>
</html>
