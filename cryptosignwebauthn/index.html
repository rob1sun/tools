<!doctype html>
<html lang="sv">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Filkrypto & Signering ‚Äì Web Crypto (l√∂senord + WebAuthn)</title>
  <style>
    :root { --bg:#0b1020; --fg:#e9ecf1; --muted:#aab3c0; --card:#121a33; --acc:#7aa2ff; --ok:#35d07f; --warn:#ffcc66; --err:#ff6b6b; }
    * { box-sizing: border-box; }
    body { margin:0; font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, "Helvetica Neue", Arial, "Noto Sans"; background:#0b1020; color:var(--fg); }
    header { padding: 20px; text-align: center; background:#121a33; position:sticky; top:0; z-index:100; }
    h1 { margin:0; font-size: 1.4rem; }
    nav { margin-top:10px; display:flex; flex-wrap:wrap; justify-content:center; gap:8px; }
    nav button { background:#172044; border:1px solid rgba(255,255,255,.1); color:var(--fg); padding:8px 12px; border-radius:8px; cursor:pointer; }
    nav button.active { background:#1a2d77; border-color:rgba(122,162,255,.45); }
    main { max-width: 1000px; margin: 0 auto; padding: 16px; }
    .card { background: rgba(18,26,51,.85); border: 1px solid rgba(255,255,255,.06); border-radius: 16px; box-shadow: 0 8px 22px rgba(0,0,0,.25); padding: 16px; backdrop-filter: blur(6px); margin-bottom:20px; }
    .card h2 { margin: 0 0 10px; font-size: 1.1rem; }
    .row { display:flex; gap:10px; flex-wrap: wrap; align-items: center; }
    textarea, input[type="password"], input[type="file"], select { width:100%; background:#0e1530; color:var(--fg); border:1px solid rgba(255,255,255,.08); border-radius: 10px; padding:8px 10px; font-size:.9rem; }
    .btn { padding:8px 12px; border-radius:8px; border:1px solid rgba(255,255,255,.1); background:#172044; color:var(--fg); cursor:pointer; }
    .btn.acc{ background:#1a2d77; }
    .btn.ok{ background:#124b33; }
    .btn.err{ background:#5a1e1e; }
    .status { margin-top:8px; font-size:.85rem; white-space:pre-wrap; color:var(--muted); }
    footer { max-width:1000px; margin:20px auto; padding:0 16px; font-size:.85rem; color:var(--muted); }
    section { display:none; }
    section.active { display:block; }
  .tabs{display:flex;gap:8px;flex-wrap:wrap;justify-content:center;margin-top:14px}
    .tab-btn{appearance:none;border:1px solid rgba(255,255,255,.12);background:#0d1530;color:var(--fg);padding:8px 12px;border-radius:999px;cursor:pointer;font-weight:600}
    .tab-btn.active{background:#1a2d77;border-color:rgba(122,162,255,.45)}
    .section{display:none}
    .section.active{display:block}
  </style>
</head>
<body>
  <header>
    <h1>Filkryptering & Signering i webbl√§saren</h1>
    <p>Web Crypto (hybrid AES‚ÄëGCM + RSA‚ÄëOAEP) och ECDSA‚Äësignering. Privata nycklar ligger krypterade i IndexedDB och kr√§ver <strong>l√∂senord</strong> och, om aktiverat, <strong>WebAuthn</strong> f√∂r att anv√§ndas.</p>
    <nav class="tabs" aria-label="Sektioner">
      <button class="tab-btn active" data-target="vault">üîê L√•s & WebAuthn</button>
      <button class="tab-btn" data-target="keys">üîë Nycklar</button>
      <button class="tab-btn" data-target="import">üì• Importera publik nyckel</button>
      <button class="tab-btn" data-target="encrypt">üß© Kryptera</button>
      <button class="tab-btn" data-target="decrypt">üóùÔ∏è Dekryptera</button>
      <button class="tab-btn" data-target="sign">‚úçÔ∏è Signera</button>
      <button class="tab-btn" data-target="verify">‚úÖ Verifiera</button>
      <button class="tab-btn" data-target="env" style="margin-left:auto">‚öôÔ∏è Milj√∂</button>
    </nav>
  </header>

  <main>
    <section class="card section" id="env" data-section>
      <h2>Milj√∂koll</h2>
      <div class="row" id="envTags"></div>
      <div class="status" id="envStatus">Initierar‚Ä¶</div>
    </section>

    <section class="card section active" id="vault" data-section>
      <h2>S√§kerhetsl√•s: L√∂senord + WebAuthn</h2>
      <p>St√§ll in ett l√∂senord och (valfritt) koppla en WebAuthn‚Äënyckel (plattform eller extern) f√∂r tv√•faktors‚Äëuppl√•sning.</p>
      <div class="grid-2">
        <div>
          <label>Skapa/√§ndra l√∂senord</label>
          <input type="password" id="setPass1" placeholder="Nytt l√∂senord" autocomplete="new-password" />
          <input type="password" id="setPass2" placeholder="Bekr√§fta l√∂senord" autocomplete="new-password" style="margin-top:8px" />
          <div class="row" style="margin-top:8px">
            <button class="btn acc" id="setPassBtn">Spara l√∂senord</button>
            <button class="btn warn" id="exportVaultBtn">Exportera krypterad backup (.keyvault.json)</button>
            <input type="file" id="importVaultFile" accept="application/json" />
          </div>
        </div>
        <div>
          <label>L√•s upp f√∂r sessionen</label>
          <input type="password" id="unlockPass" placeholder="L√∂senord f√∂r uppl√•sning" autocomplete="current-password" />
          <div class="row" style="margin-top:8px">
            <select id="autoLockMins" style="max-width:180px">
              <option value="1">Auto‚Äël√•s: 1 min</option>
              <option value="5" selected>Auto‚Äël√•s: 5 min</option>
              <option value="15">Auto‚Äël√•s: 15 min</option>
              <option value="0">Ingen auto‚Äël√•sning</option>
            </select>
            <button class="btn ok" id="unlockBtn">L√•s upp</button>
            <button class="btn" id="lockNowBtn">L√•s nu</button>
            <button class="btn err" id="wipeBtn">Rensa nycklar</button>
          </div>
          <div class="small" id="lockState">L√•sstatus: ok√§nd</div>
        </div>
      </div>

      <hr style="border-color: rgba(255,255,255,.08); margin:14px 0" />
      <div class="grid-2">
        <div>
          <label>WebAuthn‚Äëregistrering</label>
          <select id="webauthnAttachment" style="max-width:220px">
            <option value="platform">Plattform (TouchID/Windows Hello)</option>
            <option value="cross-platform">Extern (YubiKey m.fl.)</option>
            <option value="any" selected>Valfri</option>
          </select>
          <div class="row" style="margin-top:8px">
            <button class="btn acc" id="regWebAuthnBtn">Registrera WebAuthn‚Äënyckel</button>
            <button class="btn" id="testWebAuthnBtn">Testa autentisering</button>
            <button class="btn err" id="removeWebAuthnBtn">Ta bort koppling</button>
          </div>
        </div>
        <div>
          <label>Policy</label>
          <div class="row">
            <label style="display:flex; align-items:center; gap:8px"><input type="checkbox" id="requireWebAuthn" /> Kr√§v WebAuthn vid uppl√•sning (2FA)</label>
          </div>
          <div class="small" id="webauthnState">WebAuthn: ej init</div>
        </div>
      </div>
      <div class="status" id="vaultStatus">‚Äî</div>
    </section>

    <section class="card section" id="keys" data-section>
      <h2>Nycklar (din identitet)</h2>
      <p>Skapar <strong>kryptering</strong> (RSA‚ÄëOAEP 4096) & <strong>signering</strong> (ECDSA P‚Äë256). Privata nycklar sparas endast krypterade i din vault.</p>
      <div class="row">
        <button class="btn acc" id="genKeys">Generera b√•da nyckelparen</button>
      </div>
      <div class="grid-2" style="margin-top:12px">
        <div>
          <label>Exportera <strong>publik</strong> krypteringsnyckel (JWK)</label>
          <textarea id="pubEncOut" readonly placeholder="Exportera‚Ä¶"></textarea>
          <div class="row" style="margin-top:8px">
            <button class="btn" id="exportPubEnc">Exportera</button>
            <button class="btn" id="downloadPubEnc">Ladda ned .pubkey.json</button>
          </div>
        </div>
        <div>
          <label>Exportera <strong>publik</strong> signeringsnyckel (JWK)</label>
          <textarea id="pubSignOut" readonly placeholder="Exportera‚Ä¶"></textarea>
          <div class="row" style="margin-top:8px">
            <button class="btn" id="exportPubSign">Exportera</button>
            <button class="btn" id="downloadPubSign">Ladda ned .pubsigkey.json</button>
          </div>
        </div>
      </div>
      <div class="status" id="keysStatus">‚Äî</div>
    </section>

    <section class="card section" id="import" data-section>
      <h2>Importera mottagarens publika nyckel (f√∂r kryptering)</h2>
      <p>Klistra in JWK (RSA‚ÄëOAEP) eller ladda upp en .json med mottagarens <em>publika</em> nyckel.</p>
      <textarea id="theirPubJwk" placeholder='{"kty":"RSA","n":"‚Ä¶","e":"AQAB",‚Ä¶}'></textarea>
      <div class="row" style="margin-top:8px">
        <input type="file" id="theirPubFile" accept="application/json" />
        <button class="btn" id="importTheirPub">Importera nyckel</button>
      </div>
      <div class="status" id="importStatus">‚Äî</div>
    </section>

    <section class="card section" id="encrypt" data-section>
      <h2>Kryptera fil f√∂r n√•gon annan</h2>
      <p>V√§lj en fil. Den krypteras med en slumpad AES‚Äënyckel (GCM) som sedan <em>wrap:as</em> (RSA‚ÄëOAEP) med den importerade publika nyckeln.</p>
      <input type="file" id="encFile" />
      <div class="row" style="margin-top:8px">
        <button class="btn ok" id="doEncrypt">Kryptera & ladda ned .enc.json</button>
      </div>
      <div class="status" id="encStatus">‚Äî</div>
    </section>

    <section class="card section" id="decrypt" data-section>
      <h2>Dekryptera fil som krypterats till dig</h2>
      <p>Ladda upp en tidigare skapad <code>.enc.json</code>. <strong>Kr√§ver uppl√•st session</strong> (l√∂senord och ev. WebAuthn).</p>
      <input type="file" id="decFile" accept="application/json" />
      <div class="row" style="margin-top:8px">
        <button class="btn ok" id="doDecrypt">Dekryptera & ladda ned original</button>
      </div>
      <div class="status" id="decStatus">‚Äî</div>
    </section>

    <section class="card section" id="sign" data-section>
      <h2>Signera dokument</h2>
      <p>V√§lj fil att signera. ECDSA P‚Äë256 anv√§nds och en frist√•ende <code>.sig.json</code> skapas. <strong>Kr√§ver uppl√•st session</strong>.</p>
      <input type="file" id="signFile" />
      <div class="row" style="margin-top:8px">
        <button class="btn ok" id="doSign">Signera & ladda ned .sig.json</button>
      </div>
      <div class="status" id="signStatus">‚Äî</div>
    </section>

    <section class="card section" id="verify" data-section>
      <h2>Verifiera signatur</h2>
      <p>Ladda upp originalfilen och motsvarande <code>.sig.json</code> f√∂r att verifiera.</p>
      <div class="row">
        <input type="file" id="verifyFile" />
        <input type="file" id="verifySig" accept="application/json" />
      </div>
      <div class="row" style="margin-top:8px">
        <button class="btn" id="doVerify">Verifiera</button>
      </div>
      <div class="status" id="verifyStatus">‚Äî</div>
    </section>
  </main>

  <footer>
    <p>Privata nycklar √§r krypterade i IndexedDB. Uppl√•sning kr√§ver l√∂senord och ev. WebAuthn.</p>
  </footer>
<script>
// --- Tabb-styrenhet injiceras h√§r ---
(function(){
  const sections = () => Array.from(document.querySelectorAll('[data-section]'));
  function showSection(id){
    sections().forEach(s=>s.classList.toggle('active', s.id===id));
    document.querySelectorAll('.tab-btn').forEach(b=>b.classList.toggle('active', b.getAttribute('data-target')===id));
    try { history.replaceState(null, '', '#'+id); } catch(e){}
  }
  function initTabs(){
    document.querySelectorAll('.tab-btn').forEach(btn=>btn.addEventListener('click', ()=>showSection(btn.getAttribute('data-target'))));
    const start = (location.hash && location.hash.slice(1)) || 'vault';
    showSection(document.getElementById(start)? start : 'vault');
  }
  document.addEventListener('DOMContentLoaded', initTabs);
})();

// Navigation
const navButtons = document.querySelectorAll('nav button');
navButtons.forEach(btn => btn.addEventListener('click', () => {
  navButtons.forEach(b => b.classList.remove('active'));
  btn.classList.add('active');
  document.querySelectorAll('main section').forEach(sec => sec.classList.remove('active'));
  document.getElementById(btn.dataset.target).classList.add('active');
}));
(function(){
  function show(id){
    var secs=document.querySelectorAll('[data-section]');
    for(var i=0;i<secs.length;i++){ secs[i].classList.toggle('active', secs[i].id===id); }
    var btns=document.querySelectorAll('.tab-btn');
    for(var j=0;j<btns.length;j++){ btns[j].classList.toggle('active', btns[j].getAttribute('data-target')===id); }
  }
  function wire(){
    document.querySelector('nav.tabs')?.addEventListener('click', function(ev){
      var btn=ev.target.closest('.tab-btn'); if(!btn) return;
      var id=btn.getAttribute('data-target'); if(!id) return; show(id); try{ history.replaceState(null,'','#'+id);}catch(e){}
    });
    var start=(location.hash && location.hash.slice(1)) || 'vault';
    if(!document.getElementById(start)) start='vault';
    show(start);
    window.addEventListener('hashchange', function(){ var id=location.hash.slice(1); if(document.getElementById(id)) show(id); });
  }
  if(document.readyState==='loading'){ document.addEventListener('DOMContentLoaded', wire); } else { wire(); }
})();
</script>
</body>
</html>
