<!DOCTYPE html>
<html lang="sv">
<head>
<meta charset="UTF-8">
<title>Nyckelgenerator</title>
<style>
  body {font-family: Arial, sans-serif; max-width: 600px; margin: 2rem auto; line-height: 1.5;}
  h1 {text-align: center;}
  .options {margin: 1.5rem 0;}
  label {font-weight: bold; margin-right: .5rem;}
  select, button {padding: .6rem 1.2rem; font-size: 1rem; cursor: pointer;}
  #status {margin-top: 1rem; color: #006400;}
  #error  {margin-top: 1rem; color: #B22222;}
</style>
</head>
<body>

<h1>Generera RSA‑nyckelpar</h1>
<p>Välj önskad nyckelstorlek och klicka på knappen nedan. Ett RSA‑nyckelpar skapas då i din webbläsare och du kan ladda ner de två nycklarna som PEM‑filer.</p>

<div class="options">
  <label for="keySize">Nyckelstorlek:</label>
  <select id="keySize">
    <option value="2048" selected>2048 bitar</option>
    <option value="4096">4096 bitar</option>
  </select>
</div>

<button id="genBtn">Generera nycklar</button>

<div id="status"></div>
<div id="error"></div>

<script>
// Hjälpfunktion – konvertera ArrayBuffer → Base64
function arrayBufferToBase64(buf) {
    const binary = String.fromCharCode(...new Uint8Array(buf));
    return btoa(binary);
}

// Skapa PEM‑formatet
function formatPem(base64Key, label) {
    const lineLength = 64;
    const lines = [];
    for (let i = 0; i < base64Key.length; i += lineLength) {
        lines.push(base64Key.slice(i, i + lineLength));
    }
    return `-----BEGIN ${label}-----\n${lines.join('\n')}\n-----END ${label}-----`;
}

// Ladda ner en fil från en textsträng
function download(text, filename) {
    const blob = new Blob([text], {type: 'application/octet-stream'});
    const url = URL.createObjectURL(blob);
    const a   = document.createElement('a');
    a.href = url;
    a.download = filename;
    a.click();
    URL.revokeObjectURL(url);
}

// Huvudfunktion – generera nycklar med Web Crypto API
async function generateKeys() {
    const statusEl = document.getElementById('status');
    const errorEl  = document.getElementById('error');
    statusEl.textContent = '';
    errorEl.textContent  = '';

    try {
        // Hämta vald nyckelstorlek från dropdown-menyn
        const keySizeSelect = document.getElementById('keySize');
        const modulusLength = parseInt(keySizeSelect.value, 10);

        statusEl.textContent = `Skapar ${modulusLength}‑bitars nycklar…`;

        // Generera ett RSA‑nyckelpar för kryptering
        const keyPair = await window.crypto.subtle.generateKey(
            {
                name: "RSA-OAEP",
                modulusLength: modulusLength, // Använd den valda storleken
                publicExponent: new Uint8Array([1, 0, 1]), // 0x10001
                hash: "SHA-256"
            },
            true,               // exportable
            ["encrypt", "decrypt"]
        );

        // Exportera nycklarna i PKCS#8 (privat) respektive SPKI (publik) DER‑format
        const privDer = await window.crypto.subtle.exportKey("pkcs8", keyPair.privateKey);
        const pubDer  = await window.crypto.subtle.exportKey("spki",  keyPair.publicKey);

        // Konvertera till Base64 och sedan PEM
        const privPem = formatPem(arrayBufferToBase64(privDer), "PRIVATE KEY");
        const pubPem  = formatPem(arrayBufferToBase64(pubDer),  "PUBLIC KEY");

        // Ladda ner filerna
        download(privPem, `private_key_${modulusLength}.pem`);
        download(pubPem,  `public_key_${modulusLength}.pem`);

        statusEl.textContent = `${modulusLength}‑bitars nycklar har genererats och laddats ner.`;
    } catch (e) {
        console.error(e);
        errorEl.textContent = 'Ett fel uppstod: ' + e.message;
    }
}

// Bind knapptrycket
document.getElementById('genBtn').addEventListener('click', generateKeys);
</script>

</body>
</html>
