<!DOCTYPE html>
<html lang="sv">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Generellt Krypteringsverktyg (Sändare)</title>
    <style>
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; background-color: #f0f2f5; color: #1c1e21; display: flex; justify-content: center; align-items: flex-start; min-height: 100vh; margin: 0; padding: 20px; box-sizing: border-box; } main { background-color: #ffffff; border-radius: 8px; box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1); width: 100%; max-width: 700px; padding: 2rem; margin-bottom: 2rem; } h1, h2 { border-bottom: 2px solid #007bff; padding-bottom: 10px; margin-top: 0; color: #0056b3; } h2 { margin-top: 2rem; border-bottom-width: 1px; } .section { margin-bottom: 2rem; } label { display: block; font-weight: 600; margin-bottom: 8px; } textarea { width: 100%; min-height: 120px; padding: 10px; border: 1px solid #ccc; border-radius: 4px; font-family: "Courier New", Courier, monospace; font-size: 0.9rem; box-sizing: border-box; resize: vertical; } input[type="number"] { width: 100px; padding: 8px; border: 1px solid #ccc; border-radius: 4px; } button { background-color: #007bff; color: white; border: none; padding: 12px 20px; border-radius: 5px; cursor: pointer; font-size: 1rem; font-weight: 500; transition: background-color 0.2s; margin-top: 10px; } button:hover { background-color: #0056b3; } button:disabled { background-color: #a0c7ef; cursor: not-allowed; } .drop-zone { border: 2px dashed #ccc; border-radius: 8px; padding: 25px; text-align: center; color: #6c757d; cursor: pointer; transition: background-color 0.2s, border-color 0.2s; margin-top: 1rem; } .drop-zone.dragover { border-color: #007bff; background-color: #f0f8ff; } .drop-zone input[type="file"] { display: none; } .status { margin-top: 15px; padding: 10px; border-radius: 5px; text-align: center; font-weight: 500; } .status.success { background-color: #d4edda; color: #155724; } .status.error { background-color: #f8d7da; color: #721c24; } .status.info { background-color: #cce5ff; color: #004085; } .important-note { color: #dc3545; font-weight: bold; } #chunk-size-container { display: none; margin-top: 1rem; } .checkbox-label { display: flex; align-items: center; font-weight: normal; } .checkbox-label input { margin-right: 10px; }
    </style>
</head>
<body>
    <main>
        <h1>Generellt Krypteringsverktyg</h1>
        <p>Ange en publik nyckel, välj en fil och inställningar för att kryptera och ladda ner.</p>
        
        <div class="section">
            <h2>1. Ange Mottagarens Publika Nyckel</h2>
            <label for="public-key-input">Klistra in nyckeltext här:</label>
            <textarea id="public-key-input" placeholder="Klistra in en publik nyckel i JWK-format (JSON)..."></textarea>
            <div id="key-drop-zone" class="drop-zone" style="padding: 15px; margin-top: 10px;">
                <p>...eller dra och släpp en nyckelfil (.jwk, .txt) här</p>
                <input type="file" id="key-file-input" accept=".jwk,.json,.txt">
            </div>
        </div>

        <div class="section">
            <h2>2. Ladda upp Fil för Kryptering</h2>
            <div id="file-drop-zone" class="drop-zone">
                <p>Dra och släpp filen som ska krypteras här</p>
                <input type="file" id="file-input">
            </div>
        </div>

        <div class="section">
            <h2>3. Inställningar</h2>
            <label class="checkbox-label">
                <input type="checkbox" id="split-file-toggle">
                Dela upp krypterad fil i mindre delar
            </label>
            <div id="chunk-size-container">
                <label for="chunk-size-input">Maximal delstorlek (1-100 MB):</label>
                <input type="number" id="chunk-size-input" value="20" min="1" max="100">
            </div>
        </div>

        <button id="encrypt-btn">Kryptera och Ladda Ner</button>
        <div id="status-container" class="status" style="display:none;"></div>
    </main>
    <script>
    document.addEventListener('DOMContentLoaded', () => {
        // DOM-element
        const statusContainer = document.getElementById('status-container');
        const publicKeyInput = document.getElementById('public-key-input');
        const keyDropZone = document.getElementById('key-drop-zone');
        const keyFileInput = document.getElementById('key-file-input');
        const fileDropZone = document.getElementById('file-drop-zone');
        const fileInput = document.getElementById('file-input');
        const splitFileToggle = document.getElementById('split-file-toggle');
        const chunkSizeContainer = document.getElementById('chunk-size-container');
        const chunkSizeInput = document.getElementById('chunk-size-input');
        const encryptBtn = document.getElementById('encrypt-btn');

        // Krypto-konstanter
        const ENCRYPTED_KEY_SIZE = 256;
        const IV_SIZE = 12;

        // --- UI-logik och hjälpfunktioner ---
        const showStatus = (m,t='info') => { statusContainer.textContent=m; statusContainer.className=`status ${t}`; statusContainer.style.display='block'; };
        function setupDropZone(dz, i, onFileSelected) { const dt=dz.querySelector('p'); dz.addEventListener('click',()=>i.click()); ['dragover','dragleave','drop'].forEach(evName => { dz.addEventListener(evName, e=>{e.preventDefault();e.stopPropagation();if(evName==='dragover')dz.classList.add('dragover');else dz.classList.remove('dragover');});}); dz.addEventListener('drop', e=>{if(e.dataTransfer.files.length){i.files=e.dataTransfer.files;onFileSelected(i.files[0], dt);}}); i.addEventListener('change',e=>{if(e.target.files.length){onFileSelected(i.files[0], dt);}}); }
        function triggerDownload(b, f) { const u=URL.createObjectURL(b);const a=document.createElement('a');a.style.display='none';a.href=u;a.download=f;document.body.appendChild(a);a.click();URL.revokeObjectURL(u);a.remove(); }
        function sleep(ms) { return new Promise(resolve => setTimeout(resolve, ms)); }

        // Logik för att visa/dölja storleksväljaren
        splitFileToggle.addEventListener('change', () => {
            chunkSizeContainer.style.display = splitFileToggle.checked ? 'block' : 'none';
        });

        // Logik för att hantera uppladdning av nyckelfil
        function handleKeyFile(file, textElement) {
            const reader = new FileReader();
            reader.onload = e => { 
                publicKeyInput.value = e.target.result;
                showStatus(`Nyckelfil '${file.name}' inläst.`, 'success');
            };
            reader.onerror = () => showStatus(`Kunde inte läsa filen '${file.name}'.`, 'error');
            reader.readAsText(file);
            textElement.textContent = `Vald nyckelfil: ${file.name}`;
        }

        // --- Huvudfunktion ---
        async function encryptAndDownload() {
            if (!publicKeyInput.value) return showStatus('Du måste ange en publik nyckel.', 'error');
            if (fileInput.files.length === 0) return showStatus('Du måste välja en fil att kryptera.', 'error');

            try {
                showStatus('Steg 1/2: Krypterar filen...', 'info');
                encryptBtn.disabled = true;

                const file = fileInput.files[0];
                const publicKeyJwk = JSON.parse(publicKeyInput.value.trim());
                const rsaPublicKey = await crypto.subtle.importKey('jwk', publicKeyJwk, { name: 'RSA-OAEP', hash: 'SHA-256' }, true, ['encrypt']);
                const aesKey = await crypto.subtle.generateKey({ name: 'AES-GCM', length: 256 }, true, ['encrypt']);
                const exportedAesKey = await crypto.subtle.exportKey('raw', aesKey);
                const encryptedAesKey = await crypto.subtle.encrypt({ name: 'RSA-OAEP' }, rsaPublicKey, exportedAesKey);
                const iv = crypto.getRandomValues(new Uint8Array(IV_SIZE));
                const fileBuffer = await file.arrayBuffer();
                const ciphertext = await crypto.subtle.encrypt({ name: 'AES-GCM', iv: iv }, aesKey, fileBuffer);
                const encryptedBlob = new Blob([encryptedAesKey, iv, ciphertext]);

                showStatus(`Steg 2/2: Förbereder nedladdning...`, 'info');
                await sleep(500);

                const originalFileName = file.name;

                if (splitFileToggle.checked) {
                    let chunkSizeMB = parseInt(chunkSizeInput.value, 10);
                    if (isNaN(chunkSizeMB) || chunkSizeMB < 1 || chunkSizeMB > 100) {
                        showStatus('Ogiltig delstorlek. Ange ett värde mellan 1 och 100 MB.', 'error');
                        return;
                    }
                    const chunkSize = chunkSizeMB * 1024 * 1024;
                    const encryptedBuffer = await encryptedBlob.arrayBuffer();
                    const totalChunks = Math.ceil(encryptedBuffer.byteLength / chunkSize);

                    showStatus(`Delar upp i ${totalChunks} bitar om ${chunkSizeMB} MB...`, 'info');
                    for (let i = 0; i < totalChunks; i++) {
                        const start = i * chunkSize;
                        const end = start + chunkSize;
                        const chunk = encryptedBuffer.slice(start, end);
                        showStatus(`Laddar ner del ${i + 1} av ${totalChunks}...`, 'info');
                        triggerDownload(new Blob([chunk]), `${originalFileName}-del${i + 1}av${totalChunks}.txt`);
                        await sleep(300);
                    }
                    showStatus(`Kryptering klar! Filen delades upp i ${totalChunks} delar.`, 'success');
                } else {
                    // Ladda ner som en enda fil
                    triggerDownload(encryptedBlob, `krypterad-${originalFileName}`);
                    showStatus('Filen krypterades och nedladdning har startat!', 'success');
                }
            } catch (error) {
                showStatus(`Ett fel uppstod: ${error.message}. Kontrollera att den publika nyckeln är korrekt.`, 'error');
            } finally {
                encryptBtn.disabled = false;
            }
        }
        
        // --- Initiering ---
        setupDropZone(keyDropZone, keyFileInput, handleKeyFile);
        setupDropZone(fileDropZone, fileInput, (file, textElement) => {
            textElement.textContent = `Vald fil: ${file.name}`;
        });
        encryptBtn.addEventListener('click', encryptAndDownload);
    });
    </script>
</body>
</html>