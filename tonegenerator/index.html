<!DOCTYPE html>
<html lang="sv" class="h-full bg-gray-900 text-white">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ljudgenerator</title>
    <!-- Ladda Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* Anpassad stil för att matcha Inter-fonten */
        body {
            font-family: 'Inter', sans-serif;
        }

        /* Safira-stilar för Webkit (Chrome, Safari) */
        @supports (-webkit-appearance: none) {
            body {
                font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif, "Apple Color Emoji", "Segoe UI Emoji", "Segoe UI Symbol";
            }
        }

        /* Anpassad stil för reglagen */
        input[type="range"].range-lg::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 20px; /* Bredd på tummen */
            height: 20px; /* Höjd på tummen */
            background: #2dd4bf; /* Teal färg */
            cursor: pointer;
            border-radius: 50%;
            margin-top: -6px; /* Centrera tummen mot spåret */
        }

        input[type="range"].range-lg::-moz-range-thumb {
            width: 20px;
            height: 20px;
            background: #2dd4bf;
            cursor: pointer;
            border-radius: 50%;
        }
        
        /* Inaktiverade reglage */
        input[type="range"]:disabled::-webkit-slider-thumb {
             background: #4b5563; /* Gray-600 */
        }
        input[type="range"]:disabled::-moz-range-thumb {
            background: #4b5563; /* Gray-600 */
        }
        input[type="range"]:disabled + span {
            color: #6b7280; /* Gray-500 */
        }

        /* Aktiva knappar */
        button.active {
            background-color: #0d9488; /* Mörkare teal */
            border-color: #2dd4bf;
            color: white;
        }
        
        .wave-button[data-wave].active {
             background-color: #0d9488; /* Mörkare teal */
             border-color: #2dd4bf;
             color: white;
        }

        /* Styling för canvas */
        canvas {
            background-color: #1f2937; /* Gray-800 */
            border: 1px solid #4b5563; /* Gray-600 */
            border-radius: 0.5rem; /* rounded-lg */
        }
    </style>
</head>
<body class="min-h-screen flex justify-center p-4 bg-gray-900 font-sans">

    <!-- Behållare som ändrar storlek beroende på skärm -->
    <div class="w-full max-w-md lg:max-w-4xl bg-gray-800 shadow-2xl rounded-xl p-6 lg:p-8">
        
        <!-- Titel -->
        <header class="mb-6">
            <h1 class="text-3xl font-bold text-center text-teal-300">Ljudgenerator</h1>
        </header>

        <!-- Flex-container för layout (kolumn på små skärmar, rad på stora) -->
        <div class="flex flex-col lg:flex-row lg:space-x-8">

            <!-- Vänster kolumn: Kontroller -->
            <div class="flex-shrink-0 lg:w-1/2">
                <!-- Start/Stopp-knapp -->
                <div class="mb-6">
                    <button id="toggleButton" class="w-full py-3 text-lg font-bold bg-teal-600 rounded-lg hover:bg-teal-500 transition duration-150 shadow-md">
                        Starta Ljud
                    </button>
                </div>

                <!-- Frekvens-reglage -->
                <div id="frequencyContainer" class="mb-6">
                    <div class="flex justify-between items-end mb-1">
                        <label for="frequencySlider" class="block font-medium text-lg">Frekvens</label>
                        <span id="frequencyValue" class="text-lg font-mono text-teal-300">440 Hz</span>
                    </div>
                    <input id="frequencySlider" type="range" min="0" max="1000" value="535" class="w-full h-3 bg-gray-700 rounded-lg appearance-none cursor-pointer range-lg">
                </div>

                <!-- Volym-reglage -->
                <div class="mb-6">
                    <div class="flex justify-between items-end mb-1">
                        <label for="volumeSlider" class="block font-medium text-lg">Volym</label>
                        <span id="volumeValue" class="text-lg font-mono text-teal-300">50 %</span>
                    </div>
                    <input id="volumeSlider" type="range" min="0" max="100" value="50" class="w-full h-3 bg-gray-700 rounded-lg appearance-none cursor-pointer range-lg">
                </div>
                
                <!-- Ljudtyps-väljare -->
                <div>
                    <label class="block mb-2 font-medium text-lg">Ljudtyp</label>
                    <div class="grid grid-cols-2 lg:grid-cols-4 gap-2">
                        <button class="wave-button border-2 border-gray-600 py-2 rounded-lg transition duration-150 hover:border-teal-400 active" data-wave="sine">
                            Sinus
                        </button>
                        <button class="wave-button border-2 border-gray-600 py-2 rounded-lg transition duration-150 hover:border-teal-400" data-wave="square">
                            Fyrkant
                        </button>
                        <button class="wave-button border-2 border-gray-600 py-2 rounded-lg transition duration-150 hover:border-teal-400" data-wave="sawtooth">
                            Sågtand
                        </button>
                        <button class="wave-button border-2 border-gray-600 py-2 rounded-lg transition duration-150 hover:border-teal-400" data-wave="triangle">
                            Triangel
                        </button>
                        <button class="wave-button border-2 border-gray-600 py-2 rounded-lg transition duration-150 hover:border-teal-400" data-wave="whitenoise">
                            Vitt Brus
                        </button>
                        <button class="wave-button border-2 border-gray-600 py-2 rounded-lg transition duration-150 hover:border-teal-400" data-wave="pinknoise">
                            Rosa Brus
                        </button>
                        <button class="wave-button border-2 border-gray-600 py-2 rounded-lg transition duration-150 hover:border-teal-400" data-wave="brownnoise">
                            Brunt Brus
                        </button>
                    </div>
                </div>

                <!-- FFT-storlek (Upplösning) -->
                <div class="mt-6">
                    <label for="fftSizeSelect" class="block mb-2 font-medium text-lg">Upplösning (FFT)</label>
                    <select id="fftSizeSelect" class="w-full p-2 bg-gray-800 rounded-lg border border-gray-600 text-teal-300 focus:outline-none focus:ring-2 focus:ring-teal-400">
                        <option value="512">Låg (512)</option>
                        <option value="1024">Medium (1024)</option>
                        <option value="2048" selected>Hög (2048)</option>
                        <option value="4096">Mycket Hög (4096)</option>
                        <option value="8192">Ultra (8192)</option>
                    </select>
                </div>
            </div>

            <!-- Höger kolumn: Visualiseringar -->
            <div class="flex-1 mt-8 lg:mt-0">
                
                <!-- Spektrumanalysator -->
                <div>
                    <div class="flex justify-between items-center mb-2">
                        <h2 class="text-xl font-semibold">Spektrumanalysator</h2>
                        <button id="freqScaleToggle" class="px-3 py-1 text-sm border-2 border-gray-600 rounded-lg transition duration-150 hover:border-teal-400" data-scale="log">
                            Skala: Log
                        </button>
                    </div>
                    <canvas id="analyserCanvas" width="500" height="200" class="w-full h-auto"></canvas>
                    <!-- Frekvensskala -->
                    <div id="freqScaleContainer" class="flex justify-between text-xs text-gray-400 mt-1 px-1 font-mono">
                        <span id="fLabel1">20 Hz</span>
                        <span id="fLabel2">1 kHz</span>
                        <span id="fLabel3">5 kHz</span>
                        <span id="fLabel4">15 kHz</span>
                        <span id="freqScaleEnd">22k Hz</span>
                    </div>
                </div>

                <!-- Oscilloskop -->
                <div class="mt-6">
                    <div class="flex justify-between items-center mb-2">
                        <h2 class="text-xl font-semibold">Oscilloskop</h2>
                        <button id="oscTriggerToggle" class="px-3 py-1 text-sm border-2 border-gray-600 rounded-lg transition duration-150 hover:border-teal-400">
                            Trigger: Av
                        </button>
                    </div>
                    <canvas id="oscilloscopeCanvas" width="500" height="200" class="w-full h-auto"></canvas>
                    <!-- Tidsskala -->
                    <div class="flex justify-between text-xs text-gray-400 mt-1 px-1 font-mono">
                        <span>0 ms</span>
                        <span id="timeScaleEnd">43 ms</span>
                    </div>
                    <!-- Tidszoom-reglage -->
                    <div class="mt-4">
                        <label for="oscZoomSlider" class="block text-sm font-medium text-gray-400">Tidszoom</label>
                        <input id="oscZoomSlider" type="range" min="0" max="100" value="0" class="w-full h-2 bg-gray-700 rounded-lg appearance-none cursor-pointer range-lg">
                        <div class="flex justify-between text-xs text-gray-500 mt-1">
                            <span>0%</span>
                            <span>100%</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // DOM-element
        const toggleButton = document.getElementById('toggleButton');
        const frequencyContainer = document.getElementById('frequencyContainer');
        const frequencySlider = document.getElementById('frequencySlider');
        const frequencyValue = document.getElementById('frequencyValue');
        const volumeSlider = document.getElementById('volumeSlider');
        const volumeValue = document.getElementById('volumeValue');
        const waveButtons = document.querySelectorAll('.wave-button');
        const fftSizeSelect = document.getElementById('fftSizeSelect');
        
        // Canvas-element
        const canvas = document.getElementById('analyserCanvas');
        const canvasCtx = canvas.getContext('2d');
        const oscCanvas = document.getElementById('oscilloscopeCanvas');
        const oscCanvasCtx = oscCanvas.getContext('2d');

        // Skal-etiketter
        const timeScaleEnd = document.getElementById('timeScaleEnd');
        const freqScaleContainer = document.getElementById('freqScaleContainer');
        const fLabel1 = document.getElementById('fLabel1');
        const fLabel2 = document.getElementById('fLabel2');
        const fLabel3 = document.getElementById('fLabel3');
        const fLabel4 = document.getElementById('fLabel4');
        const freqScaleEnd = document.getElementById('freqScaleEnd');
        const freqScaleToggle = document.getElementById('freqScaleToggle');
        const oscTriggerToggle = document.getElementById('oscTriggerToggle');
        const oscZoomSlider = document.getElementById('oscZoomSlider');

        // Web Audio API-variabler
        let audioContext;
        let oscillator; // För vågformer
        let noiseSource; // För brus
        let gainNode;
        let analyser;
        let dataArray; // För frekvensdata
        let timeDataArray; // För tidsdata (vågform)
        let isPlaying = false;
        let currentWaveType = 'sine';
        let isFreqScaleLog = true;
        let isOscTriggered = false;
        let animationFrameId;

        // För brusgeneratorer
        let pinkNoiseNode;
        let brownNoiseNode;

        // Konstanter för logaritmisk slider
        const minFreq = 20; 
        const maxFreq = 20000;
        const minLog = Math.log(minFreq);
        const maxLog = Math.log(maxFreq);
        const logScale = (maxLog - minLog) / 1000; // 1000 är sliderns max-värde

        // --- Frekvensslider-funktioner ---
        function sliderToFrequency(sliderValue) {
            const freq = Math.exp(minLog + logScale * sliderValue);
            return Math.round(freq);
        }
        
        function frequencyToSlider(frequency) {
            const sliderValue = (Math.log(frequency) - minLog) / logScale;
            return Math.round(sliderValue);
        }

        /**
         * Hjälpfunktion för att uppdatera tidsskalan på oscilloskopet
         */
        function updateTimeScaleLabel() {
            if (!audioContext || !analyser) {
                // Sätt ett standardvärde om ljudet inte är igång
                timeScaleEnd.textContent = `... ms`;
                return;
            }
            
            // Hämta zoom-värde (0-100)
            const zoomLevel = parseInt(oscZoomSlider.value, 10);
            
            // 0 zoom = 100% av tiden. 100 zoom = 10% av tiden.
            const timeScaleFactor = (1 - (zoomLevel * 0.9 / 100));
            
            // Totala tidsfönstret för hela bufferten
            const totalTimeWindowMs = (analyser.fftSize / audioContext.sampleRate) * 1000;
            
            // Det visade tidsfönstret, justerat för zoom
            const displayedTimeWindowMs = totalTimeWindowMs * timeScaleFactor;
            
            timeScaleEnd.textContent = `${displayedTimeWindowMs.toFixed(1)} ms`;
        }

        // Sätt startpositionen för slidern till 440 Hz
        frequencySlider.value = frequencyToSlider(440);
        frequencyValue.textContent = `${sliderToFrequency(frequencySlider.value)} Hz`;

        // --- Brusgenerator-funktioner ---
        function createNoiseGenerator(type) {
            if (!audioContext) return null;
            
            const bufferSize = 2 * audioContext.sampleRate; // 2 sekunder
            const buffer = audioContext.createBuffer(1, bufferSize, audioContext.sampleRate);
            const output = buffer.getChannelData(0);

            switch (type) {
                case 'whitenoise':
                    for (let i = 0; i < bufferSize; i++) {
                        output[i] = Math.random() * 2 - 1;
                    }
                    break;
                case 'pinknoise':
                    let b0 = 0, b1 = 0, b2 = 0, b3 = 0, b4 = 0, b5 = 0, b6 = 0;
                    for (let i = 0; i < bufferSize; i++) {
                        const white = Math.random() * 2 - 1;
                        b0 = 0.99886 * b0 + white * 0.0555179;
                        b1 = 0.99332 * b1 + white * 0.0750759;
                        b2 = 0.96900 * b2 + white * 0.1538520;
                        b3 = 0.86650 * b3 + white * 0.3104856;
                        b4 = 0.55000 * b4 + white * 0.5329522;
                        b5 = -0.7616 * b5 - white * 0.0168980;
                        output[i] = b0 + b1 + b2 + b3 + b4 + b5 + b6 + white * 0.5362;
                        output[i] *= 0.11; // Skala ner
                        b6 = white * 0.115926;
                    }
                    break;
                case 'brownnoise':
                    let lastOut = 0.0;
                    for (let i = 0; i < bufferSize; i++) {
                        const white = Math.random() * 2 - 1;
                        output[i] = (lastOut + (0.02 * white)) / 1.02;
                        lastOut = output[i];
                        output[i] *= 3.5; // Skala upp
                    }
                    break;
            }

            const source = audioContext.createBufferSource();
            source.buffer = buffer;
            source.loop = true;
            return source;
        }


        // --- Huvudfunktion för ljud ---
        async function initAudio() {
            if (!audioContext) {
                audioContext = new (window.AudioContext || window.webkitAudioContext)();
            }

            if (isPlaying) {
                // Stoppa ljudet
                if (oscillator) {
                    oscillator.stop();
                    oscillator.disconnect();
                    oscillator = null;
                }
                if (noiseSource) {
                    noiseSource.stop();
                    noiseSource.disconnect();
                    noiseSource = null;
                }
                
                gainNode.disconnect();
                analyser.disconnect();
                
                // Avbryt visualiseringsloopen
                if (animationFrameId) {
                    cancelAnimationFrame(animationFrameId);
                }

                isPlaying = false;
                toggleButton.textContent = 'Starta Ljud';
                toggleButton.classList.remove('bg-red-600', 'hover:bg-red-500');
                toggleButton.classList.add('bg-teal-600', 'hover:bg-teal-500');
            } else {
                // Starta ljudet
                gainNode = audioContext.createGain();
                gainNode.gain.setValueAtTime(volumeSlider.value / 100, audioContext.currentTime);

                analyser = audioContext.createAnalyser();
                analyser.fftSize = parseInt(fftSizeSelect.value, 10); // Läs från dropdown
                const bufferLength = analyser.frequencyBinCount; // 1024
                dataArray = new Uint8Array(bufferLength); 
                timeDataArray = new Uint8Array(analyser.fftSize);

                // --- Ljudkäll-logik ---
                if (currentWaveType.includes('noise')) {
                    // Skapa brus
                    noiseSource = createNoiseGenerator(currentWaveType);
                    noiseSource.connect(gainNode);
                    noiseSource.start();
                } else {
                    // Skapa oscillator
                    oscillator = audioContext.createOscillator();
                    oscillator.type = currentWaveType;
                    const freq = sliderToFrequency(frequencySlider.value);
                    oscillator.frequency.setValueAtTime(freq, audioContext.currentTime);
                    oscillator.connect(gainNode);
                    oscillator.start();
                }
                // ---------------------

                gainNode.connect(analyser);
                analyser.connect(audioContext.destination);
                
                isPlaying = true;
                toggleButton.textContent = 'Stoppa Ljud';
                toggleButton.classList.remove('bg-teal-600', 'hover:bg-teal-500');
                toggleButton.classList.add('bg-red-600', 'hover:bg-red-500');

                // Starta visualiseringen
                draw();

                // Uppdatera skal-etiketter
                const nyquist = audioContext.sampleRate / 2;
                updateTimeScaleLabel(); // Använd hjälpfunktionen
                updateFreqScaleLabels(nyquist); // Uppdatera frekvensskalan
            }
        }

        // --- Event Listeners ---
        toggleButton.addEventListener('click', initAudio);

        frequencySlider.addEventListener('input', (e) => {
            const freq = sliderToFrequency(e.target.value);
            frequencyValue.textContent = `${freq} Hz`;
            if (oscillator && isPlaying) {
                oscillator.frequency.setValueAtTime(freq, audioContext.currentTime);
            }
        });

        volumeSlider.addEventListener('input', (e) => {
            const volume = e.target.value;
            volumeValue.textContent = `${volume} %`;
            if (gainNode && isPlaying) {
                gainNode.gain.setValueAtTime(volume / 100, audioContext.currentTime);
            }
        });

        waveButtons.forEach(button => {
            button.addEventListener('click', () => {
                // Ta bort 'active' från alla
                waveButtons.forEach(btn => btn.classList.remove('active'));
                // Lägg till 'active' på den klickade
                button.classList.add('active');
                
                const newWaveType = button.dataset.wave;
                const wasNoise = currentWaveType.includes('noise');
                const isNoise = newWaveType.includes('noise');
                currentWaveType = newWaveType;

                // Aktivera/inaktivera frekvensreglaget
                if (isNoise) {
                    frequencySlider.disabled = true;
                    frequencyContainer.classList.add('opacity-50');
                } else {
                    frequencySlider.disabled = false;
                    frequencyContainer.classList.remove('opacity-50');
                }
                
                // Om ljudet spelas, starta om det med den nya typen
                if (isPlaying) {
                    // Stoppa först det gamla ljudet
                    if (oscillator) {
                        oscillator.stop();
                        oscillator.disconnect();
                        oscillator = null;
                    }
                    if (noiseSource) {
                        noiseSource.stop();
                        noiseSource.disconnect();
                        noiseSource = null;
                    }

                    // Starta det nya ljudet
                    if (isNoise) {
                        noiseSource = createNoiseGenerator(currentWaveType);
                        noiseSource.connect(gainNode);
                        noiseSource.start();
                    } else {
                        oscillator = audioContext.createOscillator();
                        oscillator.type = currentWaveType;
                        const freq = sliderToFrequency(frequencySlider.value);
                        oscillator.frequency.setValueAtTime(freq, audioContext.currentTime);
                        oscillator.connect(gainNode);
                        oscillator.start();
                    }
                }
            });
        });
        
        function updateFreqScaleLabels(nyquist) {
            const nyquistKHz = (nyquist / 1000).toFixed(1);
            if (isFreqScaleLog) {
                fLabel1.textContent = '20 Hz';
                fLabel2.textContent = '100 Hz';
                fLabel3.textContent = '1 kHz';
                fLabel4.textContent = '5 kHz';
                freqScaleEnd.textContent = `${nyquistKHz} kHz`;
            } else {
                fLabel1.textContent = '0 kHz';
                fLabel2.textContent = `${(nyquistKHz * 0.25).toFixed(1)} kHz`;
                fLabel3.textContent = `${(nyquistKHz * 0.5).toFixed(1)} kHz`;
                fLabel4.textContent = `${(nyquistKHz * 0.75).toFixed(1)} kHz`;
                freqScaleEnd.textContent = `${nyquistKHz} kHz`;
            }
        }

        // Toggle-knapp för frekvensskala (Log/Lin)
        freqScaleToggle.addEventListener('click', () => {
            isFreqScaleLog = !isFreqScaleLog;
            if (isFreqScaleLog) {
                freqScaleToggle.textContent = 'Skala: Log';
            } else {
                freqScaleToggle.textContent = 'Skala: Lin';
            }
            if(audioContext) {
                 updateFreqScaleLabels(audioContext.sampleRate / 2);
            }
        });

        // Toggle-knapp för oscilloskop-trigger
        oscTriggerToggle.addEventListener('click', () => {
            isOscTriggered = !isOscTriggered;
            if (isOscTriggered) {
                oscTriggerToggle.textContent = 'Trigger: På';
                oscTriggerToggle.classList.add('active');
            } else {
                oscTriggerToggle.textContent = 'Trigger: Av';
                oscTriggerToggle.classList.remove('active');
            }
        });

        // FFT-storlek (Upplösning)
        fftSizeSelect.addEventListener('change', () => {
            if (!analyser) return; // Gör inget om ljudet inte startat

            const newFftSize = parseInt(fftSizeSelect.value, 10);
            analyser.fftSize = newFftSize;

            // VIKTIGT: Skapa om arrayerna med den nya storleken
            dataArray = new Uint8Array(analyser.frequencyBinCount);
            timeDataArray = new Uint8Array(analyser.fftSize); // Denna är fftSize

            // Uppdatera oscilloskopets tidsskala
            updateTimeScaleLabel();
        });
        
        // Tidszoom-reglage
        oscZoomSlider.addEventListener('input', () => {
            // Uppdatera tidsskalan direkt när man drar
            updateTimeScaleLabel();
        });

        /**
         * Ritar båda visualiseringarna i en loop
         */
        function draw() {
            if (!isPlaying) return;

            animationFrameId = requestAnimationFrame(draw);

            drawSpectrum();
            drawOscilloscope();
        }

        /**
         * Ritar spektrumanalysatorn
         */
        function drawSpectrum() {
            analyser.getByteFrequencyData(dataArray); // Få frekvensdata

            canvasCtx.fillStyle = '#1f2937'; // Gray-800 (bakgrund)
            canvasCtx.fillRect(0, 0, canvas.width, canvas.height);

            const bufferLength = analyser.frequencyBinCount; // 1024
            const barWidth = 2;
            let barHeight;
            let x = 0;
            
            const maxNyquist = audioContext ? audioContext.sampleRate / 2 : 22050;

            if (isFreqScaleLog) {
                // Logaritmisk ritning
                const minLogPlot = Math.log(1); // Starta från första bin
                const maxLogPlot = Math.log(bufferLength);
                const logRange = maxLogPlot - minLogPlot;
                
                canvasCtx.fillStyle = '#67E8F9'; // Cyan

                for (let i = 1; i < bufferLength; i++) {
                    const logIndex = Math.log(i);
                    const pos = (logIndex - minLogPlot) / logRange;
                    
                    const x = pos * canvas.width;
                    
                    // Beräkna nästa position för att bestämma bredden
                    const logIndexNext = Math.log(i + 1);
                    const posNext = (logIndexNext - minLogPlot) / logRange;
                    const width = (posNext * canvas.width) - x;

                    barHeight = dataArray[i] * (canvas.height / 255);
                    canvasCtx.fillRect(x, canvas.height - barHeight, Math.max(1, width), barHeight);
                }

            } else {
                // Linjär ritning
                const barWidth = (canvas.width / bufferLength) * 1.5;
                
                for (let i = 0; i < bufferLength; i++) {
                    barHeight = dataArray[i] * (canvas.height / 255); // Skala till canvas-höjd

                    canvasCtx.fillStyle = '#67E8F9'; // Cyan
                    canvasCtx.fillRect(x, canvas.height - barHeight, barWidth, barHeight);

                    x += barWidth + 1; // 1px mellanrum
                }
            }
        }

        /**
         * Ritar oscilloskopet (vågformen)
         */
        function drawOscilloscope() {
            analyser.getByteTimeDomainData(timeDataArray); // Få tidsdata

            oscCanvasCtx.fillStyle = '#1f2937'; // Gray-800 (bakgrund)
            oscCanvasCtx.fillRect(0, 0, oscCanvas.width, oscCanvas.height);

            const totalPoints = timeDataArray.length; // e.g., 2048
            let startPoint = 0;

            // Hantera zoom
            const zoomLevel = parseInt(oscZoomSlider.value, 10); // 0-100
            // 0 zoom = 100% av punkterna. 100 zoom = 10% av punkterna.
            const pointsToShow = totalPoints * (1 - (zoomLevel * 0.9 / 100));
            const effectivePoints = Math.max(50, pointsToShow);
            const zoomStartPoint = Math.floor((totalPoints - effectivePoints) / 2);
            
            // Hitta triggerpunkt (zero-crossing) om aktivt
            if (isOscTriggered) {
                let found = false;
                // Leta inom den första halvan av fönstret
                for (let i = 0; i < totalPoints / 2; i++) {
                    // Leta efter en punkt som går från < 128 till >= 128
                    if (timeDataArray[i] < 128 && timeDataArray[i + 1] >= 128) {
                        startPoint = i;
                        found = true;
                        break;
                    }
                }
                // Om ingen hittades, rita från zoom-startpunkten
                if (!found) {
                     startPoint = zoomStartPoint;
                }
            } else {
                // Om trigger är av, starta från zoom-startpunkten
                startPoint = zoomStartPoint;
            }

            oscCanvasCtx.lineWidth = 2;
            oscCanvasCtx.strokeStyle = '#67E8F9'; // Cyan
            oscCanvasCtx.beginPath();

            const sliceWidth = oscCanvas.width * 1.0 / effectivePoints;
            let x = 0;

            for (let i = 0; i < effectivePoints; i++) {
                const dataIndex = (startPoint + i) % totalPoints; // Se till att vi wrappar
                const v = timeDataArray[dataIndex] / 128.0; // Värde mellan 0.0 och 2.0
                const y = v * oscCanvas.height / 2;

                if (i === 0) {
                    oscCanvasCtx.moveTo(x, y);
                } else {
                    oscCanvasCtx.lineTo(x, y);
                }
                x += sliceWidth;
            }

            oscCanvasCtx.lineTo(oscCanvas.width, oscCanvas.height / 2);
            oscCanvasCtx.stroke();
        }

        // Se till att canvas-elementen har rätt storlek från början
        function resizeCanvas() {
            const containerWidth = canvas.parentElement.clientWidth;
            if (containerWidth > 0) {
                 canvas.width = containerWidth;
                 oscCanvas.width = containerWidth;
            }
        }

        window.addEventListener('resize', resizeCanvas);
        
        // Kör en gång vid start efter en liten fördröjning
        setTimeout(resizeCanvas, 100);

    </script>
</body>
</html>
