<!DOCTYPE html>
<html lang="sv">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>SAML Metadata Scope Explorer</title>
  <style>
    :root{
      --bg: #0b1020; /* deep blue */
      --panel: #121935; /* card bg */
      --muted: #8ea0b6;
      --text: #e7eef7;
      --accent: #5dd0ff;
      --accent-2: #8b5cf6;
      --danger: #ff6b6b;
      --ok: #4ade80;
      --border: #24314d;
      --chip: #1f2a4a;
    }
    html, body { height: 100%; }
    body{
      margin:0; font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, "Apple Color Emoji","Segoe UI Emoji";
      background: radial-gradient(1200px 800px at 80% -10%, #15224a, #0b1020 60%);
      color: var(--text);
    }
    a { color: var(--accent); text-decoration: none; }
    a:hover { text-decoration: underline; }

    .container{ max-width: 1100px; margin: 0 auto; padding: 24px; }

    .title{ font-size: clamp(1.4rem, 2vw + 1rem, 2.2rem); font-weight: 800; letter-spacing: .3px; }
    .subtitle{ color: var(--muted); margin-top: 6px; }

    .toolbar{
      display: grid; grid-template-columns: 1fr auto; gap: 12px; align-items: end; margin-top: 18px;
    }
    .controls{ display: grid; grid-template-columns: 1.6fr auto auto; gap: 8px; }
    .input, textarea{
      width: 100%; border: 1px solid var(--border); background: #0e1630; color: var(--text);
      padding: 10px 12px; border-radius: 12px; outline: none; transition: border-color .15s ease;
    }
    .input:focus, textarea:focus{ border-color: var(--accent); }
    .btn{
      border: 1px solid var(--border); background: linear-gradient(180deg,#1a2448,#141c3a); color: var(--text);
      padding: 10px 14px; border-radius: 12px; font-weight: 600; cursor: pointer; white-space: nowrap;
    }
    .btn:hover{ filter: brightness(1.05); }
    .btn.primary{ border-color: #2a3b7a; background: linear-gradient(180deg, #2464a8, #1f3d7a); box-shadow: inset 0 1px 0 rgba(255,255,255,.08); }
    .btn.ghost{ background: transparent; }

    .status{ margin-top: 10px; color: var(--muted); font-size: .95rem; }

    .grid{ display: grid; grid-template-columns: 1fr; gap: 12px; margin-top: 16px; }
    @media (min-width: 720px){ .grid{ grid-template-columns: 1fr 1fr; } }

    .card{
      border: 1px solid var(--border); background: linear-gradient(180deg, rgba(28,38,76,.6), rgba(16,22,46,.55));
      backdrop-filter: blur(6px);
      border-radius: 16px; padding: 16px 14px; position: relative;
    }
    .card h3{ margin: 0 0 8px 0; font-size: 1.05rem; }
    .entityid{ font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace; color: #a5b4fc; font-size: .86rem; }

    .chips{ display: flex; flex-wrap: wrap; gap: 8px; margin-top: 10px; }
    .chip{
      padding: 6px 8px; border-radius: 999px; background: var(--chip); border: 1px solid var(--border); font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono";
      font-size: .85rem; display: inline-flex; align-items: center; gap: 6px;
    }
    .badge{ font-size: .68rem; padding: 2px 6px; border-radius: 999px; border: 1px solid var(--border); background: #0e1630; color: var(--muted); }

    .header{
      display: flex; justify-content: space-between; align-items: center; gap: 12px;
    }
    .count{ color: var(--muted); font-size: .9rem; }

    .filters{ display: grid; grid-template-columns: 1fr 1fr; gap: 8px; margin-top: 12px; }
    .hint{ font-size: .9rem; color: var(--muted); }

    .footer{ margin-top: 18px; color: var(--muted); font-size: .9rem; }
    .warn { color: var(--danger); }
    .ok { color: var(--ok); }
    .hidden { display: none !important; }
    .small { font-size: .85rem; }
    .kbd{ font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono"; padding: 2px 6px; border: 1px solid var(--border); border-bottom-width: 3px; border-radius: 6px; }
  </style>
</head>
<body>
  <div class="container">
    <div class="title">SAML Metadata Scope Explorer</div>
    <div class="subtitle">Ange en URL till federationsmetadata (t.ex. <code>https://fed.sambi.se/prod/md/metadata.xml</code>) och få alla <code>shibmd:Scope</code>, grupperade per entitet. Visar <em>OrganizationDisplayName</em> och <em>entityID</em>.</div>

    <div class="toolbar">
      <div class="controls">
        <label class="small" style="display: grid; gap:6px;">
          URL till metadata
          <input id="urlInput" class="input" type="url" placeholder="https://…/metadata.xml" value="https://fed.sambi.se/prod/md/metadata.xml" />
        </label>
        <button id="fetchBtn" class="btn primary">Hämta & analysera</button>
        <details class="btn ghost" style="padding:6px 10px;">
          <summary style="cursor:pointer; list-style:none;">Alternativ</summary>
          <div style="padding:10px 0; display:grid; gap:8px;">
            <label class="small" style="display:grid; gap:6px;">
              Klistra in XML
              <textarea id="xmlPaste" rows="5" placeholder="&lt;EntitiesDescriptor …&gt;…" class="input"></textarea>
            </label>
            <button id="parsePasteBtn" class="btn">Analysera inklistrad XML</button>
            <label class="small" style="display:grid; gap:6px;">
              Eller välj XML-fil
              <input id="fileInput" type="file" accept=".xml, text/xml, application/xml" class="input" />
            </label>
          </div>
        </details>
      </div>
      <div class="header" style="justify-content:flex-end;">
        <span id="entityCount" class="count">0 entiteter</span>
      </div>
    </div>

    <div class="filters">
      <label class="small" style="display:grid; gap:6px;">
        Filtrera på namn/entityID/scope
        <input id="searchInput" class="input" type="text" placeholder="Sök… (stödjer regex med /mönster/)" />
      </label>
      <label class="small" style="display:grid; gap:6px;">
        Språk för OrganizationDisplayName (prio)
        <input id="langInput" class="input" type="text" value="sv,en" placeholder="sv,en" />
      </label>
    </div>

    <div id="status" class="status">Redo.</div>

    <div id="grid" class="grid"></div>

    <div class="footer">
      <div class="hint">Tips: Webbläsaren måste få hämta XML:en (CORS). Om du får CORS-fel, ladda ner filen och använd “Klistra in XML” eller “Välj fil”.</div>
      <div class="hint">Regex-scope markeras med badge <span class="badge">regexp</span>. Tomma/missande <em>OrganizationDisplayName</em> faller tillbaka till <em>entityID</em>.</div>
    </div>
  </div>

<script>
  const ns = {
    md: 'urn:oasis:names:tc:SAML:2.0:metadata',
    shibmd: 'urn:mace:shibboleth:metadata:1.0'
  };

  const $ = sel => document.querySelector(sel);
  const $$ = sel => Array.from(document.querySelectorAll(sel));

  const state = { entities: [], filtered: [] };

  function setStatus(msg, cls=''){
    const el = $('#status');
    el.textContent = msg;
    el.className = 'status' + (cls ? ' ' + cls : '');
  }

  async function fetchText(url){
    const resp = await fetch(url, { cache: 'no-store' });
    if(!resp.ok) throw new Error(`HTTP ${resp.status} ${resp.statusText}`);
    const ct = resp.headers.get('content-type') || '';
    const text = await resp.text();
    if(!/xml|text\//i.test(ct) && !text.trim().startsWith('<')){
      console.warn('Oväntad content-type:', ct);
    }
    return text;
  }

  function parseXML(text){
    const parser = new DOMParser();
    const xml = parser.parseFromString(text, 'application/xml');
    const err = xml.querySelector('parsererror');
    if(err){
      throw new Error('Kunde inte tolka XML: ' + err.textContent.replace(/\s+/g,' ').trim());
    }
    return xml;
  }

  function preferLang(elems, langs){
    if(!elems.length) return '';
    const langOrder = langs.map(s => s.trim().toLowerCase()).filter(Boolean);
    let best = null;
    // exact language match order
    for(const desired of langOrder){
      best = elems.find(el => (el.getAttributeNS('http://www.w3.org/XML/1998/namespace','lang') || '').toLowerCase() === desired);
      if(best) return best.textContent.trim();
    }
    // otherwise first non-empty
    best = elems.find(el => (el.textContent || '').trim());
    return (best ? best.textContent.trim() : '');
  }

  function extractEntities(doc, preferredLangs = ['sv','en']){
    const entities = Array.from(doc.getElementsByTagNameNS(ns.md, 'EntityDescriptor'));
    const out = [];
    for(const ent of entities){
      const entityID = ent.getAttribute('entityID') || '';
      // OrganizationDisplayName (may be multiple with languages)
      const org = ent.getElementsByTagNameNS(ns.md, 'Organization')[0];
      let orgNames = [];
      if(org){
        orgNames = Array.from(org.getElementsByTagNameNS(ns.md, 'OrganizationDisplayName'));
      }
      const orgName = (preferLang(orgNames, preferredLangs) || '').trim();

      // Find all shibmd:Scope anywhere within this entity
      const scopes = Array.from(ent.getElementsByTagNameNS(ns.shibmd, 'Scope')).map(s => ({
        value: (s.textContent || '').trim(),
        regexp: ((s.getAttribute('regexp') || 'false').toLowerCase() === 'true')
      })).filter(s => s.value.length);

      // Some metadata publish Scope under RoleDescriptor/Extensions; above should catch them

      if(scopes.length){
        out.push({ entityID, orgName: orgName || entityID, scopes });
      }
    }
    // sort by orgName then entityID
    out.sort((a,b)=> (a.orgName.localeCompare(b.orgName, undefined, {sensitivity:'base'}) || a.entityID.localeCompare(b.entityID)));
    return out;
  }

  function render(data){
    state.filtered = data;
    $('#entityCount').textContent = `${data.length} entiteter`;
    const grid = $('#grid');
    grid.innerHTML = '';
    for(const item of data){
      const card = document.createElement('div');
      card.className = 'card';
      const h = document.createElement('h3');
      h.textContent = item.orgName;
      const id = document.createElement('div');
      id.className = 'entityid';
      id.textContent = item.entityID;
      const chips = document.createElement('div');
      chips.className = 'chips';
      for(const sc of item.scopes){
        const chip = document.createElement('span');
        chip.className = 'chip';
        chip.innerHTML = `<span>${escapeHtml(sc.value)}</span>` + (sc.regexp ? ` <span class="badge">regexp</span>` : '');
        chips.appendChild(chip);
      }
      card.appendChild(h); card.appendChild(id); card.appendChild(chips);
      grid.appendChild(card);
    }
  }

  function escapeHtml(str){
    return (str||'').replaceAll('&','&amp;').replaceAll('<','&lt;').replaceAll('>','&gt;');
  }

  function applySearch(){
    const q = $('#searchInput').value.trim();
    if(!q){ render(state.entities); return; }
    try{
      let tester;
      if(q.startsWith('/') && q.lastIndexOf('/') > 0){
        const last = q.lastIndexOf('/');
        const pattern = q.slice(1,last);
        const flags = q.slice(last+1) || 'i';
        tester = new RegExp(pattern, flags);
      } else {
        tester = new RegExp(q.replace(/[.*+?^${}()|[\]\\]/g, '\\$&'), 'i');
      }
      const filtered = state.entities.filter(e =>
        tester.test(e.orgName) || tester.test(e.entityID) || e.scopes.some(s => tester.test(s.value))
      );
      render(filtered);
    }catch(err){
      setStatus('Ogiltigt sökmönster: ' + err.message, 'warn');
    }
  }

  async function handleURL(){
    const url = $('#urlInput').value.trim();
    if(!url){ setStatus('Ange en URL först.', 'warn'); return; }
    setStatus('Hämtar…');
    try{
      const txt = await fetchText(url);
      setStatus('Tolkar XML…');
      const xml = parseXML(txt);
      await analyzeDoc(xml);
      setStatus('Klar.', 'ok');
    }catch(err){
      console.error(err);
      setStatus('Fel: ' + err.message + ' \nOm det gäller CORS, använd “Klistra in XML” eller “Välj fil”.', 'warn');
    }
  }

  async function analyzeDoc(xml){
    const pref = $('#langInput').value.split(',').map(s=>s.trim()).filter(Boolean);
    const entities = extractEntities(xml, pref);
    state.entities = entities;
    applySearch();
  }

  $('#fetchBtn').addEventListener('click', handleURL);
  $('#parsePasteBtn').addEventListener('click', () => {
    const txt = $('#xmlPaste').value.trim();
    if(!txt){ setStatus('Klistra in XML först.', 'warn'); return; }
    try{
      const xml = parseXML(txt);
      analyzeDoc(xml);
      setStatus('Klar.', 'ok');
    }catch(err){ setStatus('Fel: ' + err.message, 'warn'); }
  });

  $('#fileInput').addEventListener('change', async (e) => {
    const file = e.target.files?.[0];
    if(!file) return;
    setStatus('Läser fil…');
    try{
      const txt = await file.text();
      const xml = parseXML(txt);
      analyzeDoc(xml);
      setStatus('Klar (fil).', 'ok');
    }catch(err){ setStatus('Fel: ' + err.message, 'warn'); }
  });

  $('#searchInput').addEventListener('input', () => {
    applySearch();
  });

  // Keyboard: Enter triggers fetch when URL focused
  $('#urlInput').addEventListener('keydown', (e)=>{ if(e.key==='Enter'){ e.preventDefault(); handleURL(); }});
</script>
</body>
</html>
