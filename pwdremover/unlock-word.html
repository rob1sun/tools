<!doctype html>
<html lang="sv">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Extrahera PDF ur Word (.docx) – klient‑side (Agile/2010+)</title>
  <style>
    :root { --bg:#0f172a; --panel:#111827ee; --accent:#22d3ee; --muted:#94a3b8; --text:#e5e7eb; --error:#f87171; --ok:#86efac; }
    html,body{height:100%}
    body{margin:0;background:radial-gradient(1200px 800px at 20% 10%,#1f2937 0,#0b1220 45%,#0a0f1c 100%);color:var(--text);font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial;display:grid;place-items:start center;padding:40px 16px}
    .app{width:min(980px,100%);background:var(--panel);border:1px solid #1f2937;border-radius:24px;box-shadow:0 10px 40px rgba(0,0,0,.35);overflow:hidden}
    header{padding:28px 32px 16px;border-bottom:1px solid #1f2937}
    header h1{margin:0 0 8px;font-size:20px}
    header p{margin:0;color:var(--muted);font-size:14px}
    .content{padding:24px 32px;display:grid;gap:18px}
    .grid{display:grid;gap:14px;grid-template-columns:1fr}
    @media (min-width:900px){.grid{grid-template-columns:1fr 1fr}}
    .drop{border:1px dashed #334155;border-radius:16px;padding:24px;text-align:center;background:#0b1220cc;transition:.2s}
    .drop.dragover{border-color:var(--accent);background:#0b1220f0}
    .drop input{display:none}
    .drop label{display:inline-block;padding:10px 14px;border-radius:12px;background:#0b1220;border:1px solid #1f2937;cursor:pointer}
    .controls{display:grid;gap:12px;grid-template-columns:1fr auto;align-items:end}
    .controls input{background:#0b1220;border:1px solid #1f2937;color:var(--text);border-radius:12px;padding:12px 14px;width:100%}
    .btn{background:linear-gradient(135deg,#06b6d4,#22d3ee);color:#002b36;font-weight:700;border:none;border-radius:12px;padding:12px 16px;cursor:pointer}
    .btn:disabled{opacity:.6;cursor:not-allowed}
    .hidden{display:none!important}
    .note{font-size:13px;color:var(--muted)}
    .status{padding:12px 14px;border-radius:12px;background:#0b1220;border:1px solid #1f2937;font-size:14px}
    .status.ok{border-color:#14532d;color:var(--ok)}
    .status.err{border-color:#7f1d1d;color:var(--error)}
    .results{display:grid;gap:10px}
    .card{display:grid;gap:8px;grid-template-columns:1fr auto;align-items:center;background:#0b1220;border:1px solid #1f2937;border-radius:12px;padding:12px 14px}
    .chip{font-size:12px;color:#a1a1aa;border:1px solid #27272a;padding:4px 8px;border-radius:999px}
    .download{text-decoration:none;padding:8px 12px;border-radius:10px;background:#1f2937;color:var(--text);border:1px solid #334155}
    details{background:#0b1220;border:1px solid #1f2937;border-radius:12px;padding:12px 14px}
    summary{cursor:pointer;color:var(--accent)}
  </style>
  <script src="https://cdn.jsdelivr.net/npm/jszip@3.10.1/dist/jszip.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/cfb@1.2.2/cfb.min.js"></script>
</head>
<body>
  <div class="app">
    <header>
      <h1>Extrahera inbäddade PDF:er från Word</h1>
      <p>Ren klient‑side. Stöd för <strong>Agile‑krypterade .docx (Office 2010+)</strong>. Äldre RC4/CryptoAPI och IRM stöds inte.</p>
    </header>

    <div class="content">
      <div class="grid">
        <div class="drop" id="drop">
          <input type="file" id="file" accept=".docx,application/vnd.openxmlformats-officedocument.wordprocessingml.document,application/octet-stream" />
          <p>Släpp din <strong>.docx</strong> här eller</p>
          <label for="file">välj fil…</label>
          <p class="note">Kräver https/localhost för WebCrypto.</p>
        </div>
        <div class="controls">
          <div>
            <label for="password" class="note">Lösenord</label>
            <input type="password" id="password" placeholder="Om filen är krypterad" />
          </div>
          <button class="btn" id="go" disabled>Analysera & extrahera</button>
        </div>
      </div>

      <details id="diag" class="hidden"><summary>Diagnostik</summary><pre id="diagpre" class="note"></pre></details>
      <div id="status" class="status hidden"></div>
      <div class="results" id="results"></div>
    </div>
  </div>

<script>
// *** Minimal felsäker version: fokuserar på filuppladdning + grundkontroller ***
(function(){
  var drop = document.getElementById('drop');
  var fileInput = document.getElementById('file');
  var goBtn = document.getElementById('go');
  var statusEl = document.getElementById('status');
  var resultsEl = document.getElementById('results');
  var passEl = document.getElementById('password');
  var pickedFile = null;

  function setStatus(msg, type){
    if (!statusEl) return;
    statusEl.className = 'status';
    if (!msg){ statusEl.classList.add('hidden'); return; }
    statusEl.classList.remove('hidden');
    statusEl.textContent = msg;
    if (type === 'ok') statusEl.classList.add('ok');
    if (type === 'err') statusEl.classList.add('err');
  }
  function humanSize(n){
    if (n < 1024) return n + ' B';
    if (n < 1024*1024) return (n/1024).toFixed(1) + ' kB';
    if (n < 1024*1024*1024) return (n/1024/1024).toFixed(1) + ' MB';
    return (n/1024/1024/1024).toFixed(1) + ' GB';
  }
  function onFiles(files){
    var f = files && files[0];
    if (!f) return;
    pickedFile = f;
    if (goBtn) goBtn.disabled = false;
    setStatus('Vald fil: ' + f.name + ' (' + humanSize(f.size) + ')', 'ok');
    if (resultsEl) resultsEl.innerHTML = '';
  }

  if (fileInput){ fileInput.addEventListener('change', function(e){ onFiles(e.target.files); }); }
  if (drop){
    ['dragenter','dragover'].forEach(function(ev){ drop.addEventListener(ev, function(e){ e.preventDefault(); e.stopPropagation(); drop.classList.add('dragover'); }); });
    ['dragleave','drop'].forEach(function(ev){ drop.addEventListener(ev, function(e){ e.preventDefault(); e.stopPropagation(); drop.classList.remove('dragover'); }); });
    drop.addEventListener('drop', function(e){ onFiles(e.dataTransfer.files); });
  }

  function readAsArrayBuffer(file){ return new Promise(function(res,rej){ var fr=new FileReader(); fr.onload=function(){res(fr.result)}; fr.onerror=function(){rej(fr.error||'filfel')}; fr.readAsArrayBuffer(file); }); }
  function u8equals(a,b){ if (a.length!==b.length) return false; for (var i=0;i<a.length;i++){ if (a[i]!==b[i]) return false; } return true; }
  function isZip(u8){ var sigs=[[0x50,0x4B,0x03,0x04],[0x50,0x4B,0x05,0x06],[0x50,0x4B,0x07,0x08]]; for (var i=0;i<sigs.length;i++){ var s=sigs[i]; var ok=true; for (var j=0;j<4;j++){ if (u8[j]!==s[j]) {ok=false; break;} } if (ok) return true; } return false; }
  function isCFB(u8){ var sig=[0xD0,0xCF,0x11,0xE0,0xA1,0xB1,0x1A,0xE1]; for (var i=0;i<8;i++){ if (u8[i]!==sig[i]) return false; } return true; }

  function listZip(u8){
    return JSZip.loadAsync(u8).then(function(zip){
      var files = Object.keys(zip.files);
      var html = '<div class="card"><div><strong>ZIP‑innehåll</strong><div class="chip">'+files.length+' filer</div></div></div>';
      if (resultsEl) resultsEl.innerHTML = html;
      setStatus('Det här ser ut som en okrypterad .docx (ZIP).', 'ok');
    });
  }

  function onGo(){
    if (!pickedFile){ setStatus('Ingen fil vald.', 'err'); return; }
    setStatus('Läser fil …');
    readAsArrayBuffer(pickedFile).then(function(ab){
      var u8 = new Uint8Array(ab);
      if (isZip(u8)) return listZip(u8);
      if (isCFB(u8)){
        setStatus('Det här ser ut som en krypterad .docx (CFB). Ange lösenord och vänta på nästa bygge av dekryptering.', 'ok');
        return;
      }
      setStatus('Okänt format. Förväntade .docx (ZIP) eller krypterad .docx (CFB).', 'err');
    }).catch(function(err){ setStatus('Fel: '+(err && err.message? err.message : String(err)), 'err'); });
  }
  if (goBtn){ goBtn.addEventListener('click', onGo); }
})();
</script>
</body>
</html>
