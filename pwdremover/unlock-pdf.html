<!-- Version: 6.0 (Integrerad ESM-l√∂sning) -->
<!DOCTYPE html>
<html lang="sv">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>PDF Unlocker ‚Äì ESM (WASM, bevarar text/vektorer)</title>
<style>
  :root { --bg:#0b1020; --card:#151b2e; --muted:#9aa3b2; --accent:#7cc2ff; --err:#ff6b6b; }
  *{box-sizing:border-box}
  body{margin:0;font-family:Inter,system-ui,Segoe UI,Roboto,Helvetica,Arial,sans-serif;background:linear-gradient(160deg,#0b1020,#0e1426 60%,#0b1020);color:#e9eef7; display: flex; align-items: center; justify-content: center; min-height: 100vh;}
  .wrap{width: 100%; max-width:500px;margin:32px auto;padding:0 16px}
  header{display:flex;align-items:center;gap:12px;margin-bottom:16px}
  header h1{font-size:22px;margin:0}
  header .badge{font-size:12px;background:#24304e;color:#cfe3ff;padding:4px 8px;border-radius:999px; white-space: nowrap;}
  .card{background:linear-gradient(180deg,#161c31,#121829);border:1px solid #222a44;border-radius:16px;box-shadow:0 20px 60px rgba(0,0,0,.35);padding:24px}
  label{font-size:13px;color:#cfd6e6;margin-bottom:6px;display:block}
  input,button{width:100%;padding:12px 14px;border-radius:12px;border:1px solid #2a3454;background:#0f1425;color:#e9eef7;outline:none; font-size: 1rem;}
  input::file-selector-button{border:0;background:#1d2744;color:#cfe3ff;padding:10px 12px;border-radius:10px;margin-right:10px; cursor: pointer;}
  button{cursor:pointer;background:#1b8fff;border-color:#2d6df0;font-weight:600; transition: background-color 0.2s ease;}
  button:hover:not(:disabled) { background-color: #389fff; }
  button:disabled{opacity:.6;cursor:not-allowed}
  .progress{margin-top:12px;background:#0e1425;border:1px solid #253055;border-radius:12px;overflow:hidden;height:12px}
  .bar{height:100%;width:0%;background:linear-gradient(90deg,#3ba6ff,#43d787); transition: width 0.3s ease;}
  .log{margin-top:10px;font-family:ui-monospace,Menlo,Consolas,monospace;background:#0a0f1d;border:1px dashed #2a3454;padding:12px;border-radius:10px;white-space:pre-wrap; word-wrap: break-word;}
  .muted{font-size:12px;color:#9aa3b2}
</style>
</head>
<body>
  <div class="wrap">
    <header>
      <h1>üîì PDF Unlocker</h1>
      <span class="badge">Allt sker lokalt</span>
    </header>

    <div class="card">
      <label>Steg 1 &middot; V√§lj l√∂senordsskyddad PDF</label>
      <input id="file" type="file" accept="application/pdf" />
      <div class="muted">Filen l√§mnar aldrig din dator.</div>

      <label style="margin-top:12px">Steg 2 &middot; Ange l√∂senord</label>
      <input id="pwd" type="password" placeholder="L√§mna tomt om inget l√∂senord kr√§vs f√∂r att √∂ppna" />

      <label style="margin-top:12px">Filnamn p√• utdata</label>
      <input id="outName" type="text" placeholder="min-fil-unlocked.pdf" />

      <div style="margin-top:14px">
        <button id="go">L√•s upp och spara PDF</button>
      </div>

      <div class="progress" style="margin-top:14px"><div id="bar" class="bar"></div></div>
      <div id="status" class="log" style="display:none"></div>
      <div class="muted" style="margin-top:8px">OBS: Du beh√∂ver k√§nna till l√∂senordet. Respektera upphovsr√§tt.</div>
    </div>
  </div>

  <script type="module">
    // Importerar en ESM-version av qpdf-wasm d√§r .wasm-filen √§r inb√§ddad.
    // Detta g√∂r att vi slipper hantera flera filer.
    import QPDF from "https://cdn.jsdelivr.net/npm/qpdf-wasm-esm-embedded@1.1.1/+esm";

    const $ = (id) => document.getElementById(id);
    const fileEl = $('file'), pwdEl = $('pwd'), outEl = $('outName'), goEl = $('go');
    const bar = $('bar'), status = $('status');

    function setProgress(p, msg){
      bar.style.width = Math.max(0, Math.min(100, p)) + '%';
      if(msg){ status.style.display = 'block'; status.textContent = msg; }
    }
    function saveBlob(name, data){
      const url = URL.createObjectURL(new Blob([data], {type:'application/pdf'}));
      const a = document.createElement('a');
      a.href = url;
      a.download = name;
      document.body.appendChild(a); // N√∂dv√§ndigt f√∂r Firefox
      a.click();
      document.body.removeChild(a);
      setTimeout(()=>URL.revokeObjectURL(url), 4000);
    }
    function humanError(e){
      const s = (e && (e.message || String(e))) || 'Ok√§nt fel.';
      if(/password/i.test(s) && /(wrong|invalid|incorrect)/i.test(s)) return 'Fel l√∂senord ‚Äì f√∂rs√∂k igen.';
      if(/encrypted/i.test(s) && /no password/i.test(s)) return 'Filen kr√§ver ett l√∂senord f√∂r att √∂ppnas.';
      return s;
    }
    function suggestOutName(){
      const f = fileEl.files && fileEl.files[0];
      if(f && !outEl.value) outEl.value = f.name.replace(/\.pdf$/i,'') + '-unlocked.pdf';
    }
    fileEl.addEventListener('change', suggestOutName);

    async function run(){
      const f = fileEl.files && fileEl.files[0];
      if(!f){ setProgress(0,'V√§lj en PDF-fil f√∂rst.'); return; }
      const pwd = (pwdEl.value || '').trim();
      const outName = (outEl.value || f.name.replace(/\.pdf$/i,'-unlocked.pdf')).replace(/\s+/g,'-');

      goEl.disabled = true; status.style.display = 'block'; status.textContent = '';
      try{
        setProgress(5,'L√§ser in fil...');
        const inBytes = new Uint8Array(await f.arrayBuffer());

        setProgress(20,'Initierar QPDF (WASM)...');
        const qpdf = await QPDF();

        const IN = "/in.pdf", OUT = "/out.pdf";
        try { if(qpdf.FS.analyzePath(IN).exists) qpdf.FS.unlink(IN); } catch{}
        try { if(qpdf.FS.analyzePath(OUT).exists) qpdf.FS.unlink(OUT); } catch{}

        setProgress(35,'Skriver indata till virtuellt filsystem...');
        qpdf.FS.writeFile(IN, inBytes);

        setProgress(60,'Dekrypterar...');
        const args = pwd
          ? [`--password=${pwd}`, '--decrypt', IN, OUT]
          : ['--decrypt', IN, OUT]; // Hanterar filer med endast √§garl√∂senord

        qpdf.callMain(args); // Kastar ett fel om l√∂senordet √§r fel

        setProgress(80,'L√§ser resultat...');
        const outBytes = qpdf.FS.readFile(OUT);

        setProgress(95,'Sparar fil...');
        saveBlob(outName, outBytes);
        setProgress(100,'Klar! Sparade okrypterad PDF.');
      }catch(err){
        setProgress(0, ''); // Nollst√§ll progressbaren vid fel
        status.textContent = '‚ùå ' + humanError(err);
      }finally{
        goEl.disabled = false;
      }
    }

    goEl.addEventListener('click', run);
    pwdEl.addEventListener('keydown', (e)=>{ if(e.key === 'Enter') run(); });
  </script>
</body>
</html>
