<!DOCTYPE html>
<html lang="sv">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ta bort lösenord från PDF (WASM-version)</title>
    <!-- Inkluderar Tailwind CSS för styling -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Inkluderar qpdf-wasm biblioteket med säkerhetsintegritet -->
    <script src="https://cdn.jsdelivr.net/npm/qpdf-wasm@1.0.3/dist/qpdf-wasm.js" 
            xintegrity="sha384-b03fPR04i3y3q27y2ZW22N2aH2iQUP5XhQ2An9eURb22rO0yI240H2s2Tf2s+O2+" 
            crossorigin="anonymous"></script>
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap">
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }
        .file-input-button {
            cursor: pointer;
            display: inline-block;
            text-align: center;
            transition: background-color 0.3s, border-color 0.3s, opacity 0.3s;
        }
        .file-input-button:hover:not(.disabled) {
            background-color: #f3f4f6;
        }
        .file-input-button.disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        input[type="file"] {
            display: none;
        }
        /* Stil för laddningsspinner */
        .loader {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #4f46e5;
            border-radius: 50%;
            width: 24px;
            height: 24px;
            animation: spin 1s linear infinite;
            display: inline-block;
            margin-right: 10px;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body class="bg-gray-100 flex items-center justify-center min-h-screen">

    <div class="w-full max-w-md mx-auto bg-white rounded-xl shadow-lg p-8 space-y-6">
        <!-- Rubrik och beskrivning -->
        <div class="text-center">
            <h1 class="text-3xl font-bold text-gray-800">PDF Lösenordsborttagare</h1>
            <p class="text-gray-500 mt-2"><span class="font-semibold text-indigo-600">WASM-version:</span> Kraftfull nog för de flesta krypteringar.</p>
        </div>

        <!-- Formulär för uppladdning -->
        <div class="space-y-4">
            <div>
                <label for="pdfFile" id="fileInputLabel" class="file-input-button w-full border-2 border-dashed border-gray-300 rounded-lg p-6 text-center disabled">
                    <svg class="mx-auto h-12 w-12 text-gray-400" stroke="currentColor" fill="none" viewBox="0 0 48 48" aria-hidden="true">
                        <path d="M28 8H12a4 4 0 00-4 4v20m32-12v8m0 0v8a4 4 0 01-4 4H12a4 4 0 01-4-4v-4m32-4l-3.172-3.172a4 4 0 00-5.656 0L28 28M8 32l9.172-9.172a4 4 0 015.656 0L28 28m0 0l4 4m4-24h8m-4-4v8" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" />
                    </svg>
                    <span id="fileName" class="mt-2 block text-sm font-medium text-gray-600">Klicka för att välja en PDF-fil</span>
                </label>
                <input type="file" id="pdfFile" accept=".pdf" class="hidden" disabled>
            </div>
            
            <div>
                <label for="password" class="block text-sm font-medium text-gray-700 mb-1">Lösenord</label>
                <input type="password" id="password" placeholder="Ange PDF-lösenordet" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 transition" disabled>
            </div>
        </div>

        <!-- Knapp för att ta bort lösenord -->
        <button id="unlockButton" class="w-full bg-indigo-600 text-white font-bold py-3 px-4 rounded-lg hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500 transition duration-300 ease-in-out disabled:bg-gray-400 flex items-center justify-center" disabled>
            <span id="buttonText">Lås upp och ta bort lösenord</span>
        </button>

        <!-- Meddelande- och nedladdningsområde -->
        <div id="status" class="text-center text-sm font-medium pt-2"></div>
        <div id="downloadArea" class="hidden text-center">
            <a id="downloadLink" class="w-full inline-block bg-green-600 text-white font-bold py-3 px-4 rounded-lg hover:bg-green-700 transition duration-300 ease-in-out">
                Ladda ner olåst PDF
            </a>
        </div>
    </div>

    <script>
        // Hämta referenser till HTML-element
        const fileInputLabel = document.getElementById('fileInputLabel');
        const pdfFileInput = document.getElementById('pdfFile');
        const passwordInput = document.getElementById('password');
        const unlockButton = document.getElementById('unlockButton');
        const statusDiv = document.getElementById('status');
        const downloadArea = document.getElementById('downloadArea');
        const downloadLink = document.getElementById('downloadLink');
        const fileNameSpan = document.getElementById('fileName');
        const buttonText = document.getElementById('buttonText');

        function showStatus(message, type = 'info') {
            statusDiv.textContent = message;
            statusDiv.classList.remove('text-red-600', 'text-green-600', 'text-gray-600');
            if (type === 'error') statusDiv.classList.add('text-red-600');
            else if (type === 'success') statusDiv.classList.add('text-green-600');
            else statusDiv.classList.add('text-gray-600');
        }
        
        (async function main() {
            showStatus('Laddar PDF-motorn, vänligen vänta...', 'info');
            
            // Kontrollera först om skriptet för motorn har laddats
            if (typeof window.qpdfWasm === 'undefined') {
                showStatus('Kritiskt fel: Kunde inte ladda skriptet för PDF-motorn. Detta kan bero på nätverksblockeringar eller webbläsartillägg.', 'error');
                buttonText.textContent = 'Fel vid laddning';
                return;
            }

            try {
                const qpdf = window.qpdfWasm;
                await qpdf.init();

                // Aktivera UI när motorn är redo
                pdfFileInput.disabled = false;
                passwordInput.disabled = false;
                unlockButton.disabled = false;
                fileInputLabel.classList.remove('disabled');
                showStatus('PDF-motorn är redo. Välj en fil.', 'success');

            } catch (err) {
                console.error("Kunde inte initiera WASM-modulen:", err);
                showStatus('Kritiskt fel: Kunde inte starta PDF-motorn. Prova att ladda om sidan, kontrollera din nätverksanslutning eller inaktivera webbläsartillägg.', 'error');
                buttonText.textContent = 'Fel vid start';
                return;
            }

            pdfFileInput.addEventListener('change', () => {
                if (pdfFileInput.files.length > 0) {
                    fileNameSpan.textContent = pdfFileInput.files[0].name;
                    fileNameSpan.classList.add('text-indigo-600');
                    statusDiv.textContent = '';
                    downloadArea.classList.add('hidden');
                } else {
                    fileNameSpan.textContent = 'Klicka för att välja en PDF-fil';
                    fileNameSpan.classList.remove('text-indigo-600');
                }
            });

            unlockButton.addEventListener('click', async () => {
                const file = pdfFileInput.files[0];
                const password = passwordInput.value;

                if (!file) { showStatus('Vänligen välj en PDF-fil.', 'error'); return; }
                if (!password) { showStatus('Vänligen ange ett lösenord.', 'error'); return; }

                setLoadingState(true);
                
                setTimeout(async () => {
                    try {
                        const fileBuffer = await file.arrayBuffer();
                        const pdfBytes = new Uint8Array(fileBuffer);

                        const unlockedPdfBytes = window.qpdfWasm.decrypt(pdfBytes, password);

                        const blob = new Blob([unlockedPdfBytes], { type: 'application/pdf' });
                        const url = URL.createObjectURL(blob);
                        
                        downloadLink.href = url;
                        const originalName = file.name.replace(/\.pdf$/i, '');
                        downloadLink.download = `${originalName}_unlocked.pdf`;
                        
                        downloadArea.classList.remove('hidden');
                        showStatus('PDF:en är upplåst! Klicka nedan för att ladda ner.', 'success');

                    } catch (err) {
                        console.error("Fel vid upplåsning av PDF med WASM:", err);
                        let errorMessage = 'Kunde inte låsa upp PDF. Kontrollera lösenordet eller så är filen skadad.';
                        if (err.message && err.message.includes('invalid password')) {
                            errorMessage = 'Fel lösenord angivet.';
                        }
                        showStatus(errorMessage, 'error');
                    } finally {
                        setLoadingState(false);
                    }
                }, 50);
            });
        })();

        function setLoadingState(isLoading) {
            unlockButton.disabled = isLoading;
            if (isLoading) {
                buttonText.innerHTML = '<span class="loader"></span>Arbetar...';
                showStatus('Dekrypterar med WASM-motorn...', 'info');
                downloadArea.classList.add('hidden');
            } else {
                buttonText.innerHTML = 'Lås upp och ta bort lösenord';
            }
        }
    </script>
</body>
</html>
