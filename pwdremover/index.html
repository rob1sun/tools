<!DOCTYPE html>
<html lang="sv">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>PDF Unlocker – ESM + QPDF (WASM, bevarar text/vektorer)</title>
<style>
  :root { --bg:#0b1020; --card:#151b2e; --muted:#9aa3b2; --accent:#7cc2ff; --err:#ff6b6b; }
  *{box-sizing:border-box}
  body{margin:0;font-family:Inter,system-ui,Segoe UI,Roboto,Helvetica,Arial,sans-serif;background:linear-gradient(160deg,#0b1020,#0e1426 60%,#0b1020);color:#e9eef7}
  .wrap{max-width:920px;margin:32px auto;padding:0 16px}
  header{display:flex;align-items:center;gap:12px;margin-bottom:16px}
  header h1{font-size:22px;margin:0}
  header .badge{font-size:12px;background:#24304e;color:#cfe3ff;padding:4px 8px;border-radius:999px}
  .card{background:linear-gradient(180deg,#161c31,#121829);border:1px solid #222a44;border-radius:16px;box-shadow:0 20px 60px rgba(0,0,0,.35);padding:18px}
  label{font-size:13px;color:#cfd6e6;margin-bottom:6px;display:block}
  input,button{width:100%;padding:12px 14px;border-radius:12px;border:1px solid #2a3454;background:#0f1425;color:#e9eef7;outline:none}
  input::file-selector-button{border:0;background:#1d2744;color:#cfe3ff;padding:10px 12px;border-radius:10px;margin-right:10px}
  button{cursor:pointer;background:#1b8fff;border-color:#2d6df0;font-weight:600}
  button:disabled{opacity:.6;cursor:not-allowed}
  .progress{margin-top:12px;background:#0e1425;border:1px solid #253055;border-radius:12px;overflow:hidden;height:12px}
  .bar{height:100%;width:0%;background:linear-gradient(90deg,#3ba6ff,#43d787)}
  .log{margin-top:10px;font-family:ui-monospace,Menlo,Consolas,monospace;background:#0a0f1d;border:1px dashed #2a3454;padding:12px;border-radius:10px;white-space:pre-wrap}
  .muted{font-size:12px;color:#9aa3b2}
</style>
</head>
<body>
  <div class="wrap">
    <header>
      <h1>🔓 PDF Unlocker – ESM + QPDF (WASM)</h1>
      <span class="badge">All bearbetning sker lokalt i din webbläsare</span>
    </header>

    <div class="card">
      <label>Steg 1 · Välj lösenordsskyddad PDF</label>
      <input id="file" type="file" accept="application/pdf" />
      <div class="muted">Filen stannar lokalt i webbläsaren.</div>

      <label style="margin-top:12px">Steg 2 · Ange lösenord</label>
      <input id="pwd" type="password" placeholder="Lösenord (lämna tomt om endast ägarskydd)" />

      <label style="margin-top:12px">Filnamn på utdata</label>
      <input id="outName" type="text" placeholder="minfil-unlocked.pdf" />

      <div style="margin-top:14px">
        <button id="go">Lås upp & spara okrypterad PDF</button>
      </div>

      <div class="progress" style="margin-top:14px"><div id="bar" class="bar"></div></div>
      <div id="status" class="log" style="display:none"></div>
      <div class="muted" style="margin-top:8px">OBS: Du behöver känna till lösenordet. Respektera lagar/licenser.</div>
    </div>
  </div>

  <script type="module">
    import createModule from "https://unpkg.com/@neslinesli93/qpdf-wasm@0.3.0/dist/qpdf.js?module";

    const $ = (id) => document.getElementById(id);
    const fileEl = $('file'), pwdEl = $('pwd'), outEl = $('outName'), goEl = $('go');
    const bar = $('bar'), status = $('status');

    function setProgress(p, msg){
      bar.style.width = Math.max(0, Math.min(100, p)) + '%';
      if(msg){ status.style.display = 'block'; status.textContent = msg; }
    }
    function saveBlob(name, data){
      const url = URL.createObjectURL(new Blob([data], {type:'application/pdf'}));
      const a = document.createElement('a'); a.href = url; a.download = name; a.click();
      setTimeout(()=>URL.revokeObjectURL(url), 4000);
    }
    function humanError(e){
      const s = (e && (e.message || String(e))) || 'Okänt fel.';
      if(/password/i.test(s) && /(wrong|invalid|incorrect)/i.test(s)) return 'Fel lösenord – försök igen.';
      if(/encrypted/i.test(s) && /no password/i.test(s)) return 'Filen kräver lösenord.';
      return s;
    }
    function suggestOutName(){
      const f = fileEl.files && fileEl.files[0];
      if(f && !outEl.value) outEl.value = f.name.replace(/\.pdf$/i,'') + '-unlocked.pdf';
    }
    fileEl.addEventListener('change', suggestOutName);

    async function run(){
      const f = fileEl.files && fileEl.files[0];
      if(!f){ setProgress(0,'Välj en PDF-fil först.'); return; }
      const pwd = (pwdEl.value || '').trim();
      const outName = (outEl.value || f.name.replace(/\.pdf$/i,'-unlocked.pdf')).replace(/\s+/g,'-');

      goEl.disabled = true; status.style.display = 'block'; status.textContent = '';
      try{
        setProgress(5,'Läser in fil…');
        const inBytes = new Uint8Array(await f.arrayBuffer());

        setProgress(20,'Initierar QPDF (WASM)…');
        const qpdf = await createModule({
          locateFile: (path) => {
            // Låt modulen hitta qpdf.wasm på samma CDN
            if (path.endsWith('.wasm')) {
              return 'https://unpkg.com/@neslinesli93/qpdf-wasm@0.3.0/dist/qpdf.wasm';
            }
            return path;
          }
        });

        const IN = 'in.pdf', OUT = 'out.pdf';
        // Städa ev. tidigare körningar
        try { if(qpdf.FS.analyzePath(IN).exists) qpdf.FS.unlink(IN); } catch{}
        try { if(qpdf.FS.analyzePath(OUT).exists) qpdf.FS.unlink(OUT); } catch{}

        setProgress(35,'Skriver indata till virtuellt filsystem…');
        qpdf.FS.writeFile(IN, inBytes);

        setProgress(60,'Dekrypterar med qpdf…');
        const args = pwd
          ? [`--password=${pwd}`, '--decrypt', IN, OUT]
          : ['--decrypt', IN, OUT]; // ägarskydd: inget lösenord

        // Kör CLI; kastar vid fel (t.ex. fel lösenord)
        qpdf.callMain(args);

        setProgress(80,'Läser resultat…');
        const outBytes = qpdf.FS.readFile(OUT);

        setProgress(95,'Sparar fil…');
        saveBlob(outName, outBytes);
        setProgress(100,'Klar! Sparade okrypterad PDF.');
      }catch(err){
        status.textContent = '❌ ' + humanError(err);
      }finally{
        goEl.disabled = false;
      }
    }

    goEl.addEventListener('click', run);
    pwdEl.addEventListener('keydown', (e)=>{ if(e.key === 'Enter') run(); });
  </script>
</body>
</html>
