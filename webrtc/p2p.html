<!DOCTYPE html>
<html lang="sv">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Säker P2P Chatt, Video & Fildelning v6</title>
    
    <script src="https://unpkg.com/peerjs@1.5.4/dist/peerjs.min.js"></script>

    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            background-color: #f0f2f5; color: #1c1e21; margin: 0; padding: 20px;
            display: flex; justify-content: center; align-items: flex-start; min-height: 100vh;
        }
        #app-container {
            width: 100%; max-width: 700px; background-color: #ffffff;
            border-radius: 8px; box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
            padding: 24px; box-sizing: border-box;
        }
        h1, h2 { border-bottom: 1px solid #dddfe2; padding-bottom: 10px; margin-top: 0; }
        #my-id-container {
            display: flex; justify-content: space-between; align-items: center;
            background-color: #e7f3ff; border: 1px solid #cce0ff; border-radius: 6px;
            padding: 10px 15px; margin-bottom: 20px; word-break: break-all;
        }
        #my-id { font-weight: bold; color: #00529b; }
        #copy-id-btn { padding: 6px 12px; font-size: 14px; background-color: #4267B2; font-weight: normal; margin-left: 15px; white-space: nowrap; }
        #copy-id-btn:hover { background-color: #365899; }
        #connection-controls, #chat-controls { display: flex; gap: 10px; margin-bottom: 20px; }
        input[type="text"] { flex-grow: 1; padding: 10px; border: 1px solid #dddfe2; border-radius: 6px; font-size: 16px; }
        button { padding: 10px 20px; font-size: 16px; font-weight: bold; color: #fff; background-color: #1877f2; border: none; border-radius: 6px; cursor: pointer; transition: background-color 0.2s; }
        button:hover { background-color: #166fe5; }
        button:disabled { background-color: #a0a0a0; cursor: not-allowed; }
        #call-btn-container { margin-bottom: 20px; }
        #end-call-btn { background-color: #dc3545; }
        #end-call-btn:hover { background-color: #c82333; }
        #video-container { position: relative; width: 100%; background-color: #000; border-radius: 6px; overflow: hidden; margin-bottom: 20px; display: none; }
        #remote-video { width: 100%; height: auto; display: block; }
        #local-video { position: absolute; width: 25%; max-width: 180px; bottom: 15px; right: 15px; border: 2px solid #fff; border-radius: 6px; box-shadow: 0 2px 5px rgba(0,0,0,0.3); }
        #chat-log { height: 200px; border: 1px solid #dddfe2; border-radius: 6px; padding: 10px; margin-bottom: 20px; overflow-y: scroll; background-color: #f7f7f7; }
        .message { padding: 8px 12px; border-radius: 18px; margin-bottom: 8px; max-width: 80%; word-wrap: break-word; }
        .message.sent { background-color: #0084ff; color: white; margin-left: auto; text-align: right; }
        .message.received { background-color: #e4e6eb; color: #050505; margin-right: auto; text-align: left; }
        .message.system { background-color: #fffbe6; color: #9c6f00; text-align: center; max-width: 100%; font-style: italic; }
        .message a { color: #00529b; font-weight: bold; }
        #status { padding: 10px; border-radius: 6px; margin-top: 15px; font-weight: 500; }
        .status-waiting { background-color: #fffbe6; color: #9c6f00; }
        .status-connected { background-color: #e9f6ec; color: #006422; }
        .status-error { background-color: #fbeae5; color: #b71d1d; }

        /* --- NYTT: Förbättrad stil för fildelning --- */
        #drop-zone {
            border: 2px dashed #ccc;
            border-radius: 6px;
            padding: 25px;
            text-align: center;
            background-color: #f8f9fa;
            transition: background-color 0.2s, border-color 0.2s;
            margin-bottom: 15px;
        }
        #drop-zone p {
            margin: 0 0 15px 0;
            color: #606770;
        }
        #drop-zone.drag-over {
            background-color: #e7f3ff;
            border-color: #1877f2;
        }
        #file-input { display: none; }
        .file-label-btn { padding: 10px 15px; background-color: #6c757d; border-radius: 6px; color: white; cursor: pointer; display: inline-block; }
        #file-selection-info { display: flex; align-items: center; gap: 10px; }
        #selected-file-name { font-style: italic; color: #606770; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; flex-grow: 1; }
    </style>
</head>
<body>

    <div id="app-container">
        <h1>Säker P2P Chatt, Video & Fildelning</h1>
        <div id="my-id-container">
            <span>Ditt Peer ID: <span id="my-id">Laddar...</span></span>
            <button id="copy-id-btn" title="Kopiera ID" disabled>Kopiera</button>
        </div>

        <h2>1. Anslut till en annan användare</h2>
        <div id="connection-controls">
            <input type="text" id="peer-id-input" placeholder="Klistra in Peer ID här">
            <button id="connect-btn">Anslut</button>
        </div>
        <div id="status" class="status-waiting">Status: Väntar på anslutning...</div>

        <h2>2. Videosamtal (Krypterat)</h2>
        <div id="video-container">
            <video id="remote-video" autoplay playsinline></video>
            <video id="local-video" autoplay playsinline muted></video>
        </div>
        <div id="call-btn-container">
            <button id="start-call-btn" disabled>Starta videosamtal</button>
            <button id="end-call-btn" style="display: none;">Avsluta samtal</button>
        </div>

        <h2>3. Textchatt (Krypterad)</h2>
        <div id="chat-log"></div>
        <div id="chat-controls">
            <input type="text" id="message-input" placeholder="Skriv ett meddelande..." disabled>
            <button id="send-btn" disabled>Skicka</button>
        </div>

        <h2>4. Fildelning (Krypterat)</h2>
        <div id="drop-zone">
            <p>Dra och släpp en fil här, eller</p>
            <label for="file-input" class="file-label-btn">Välj fil från datorn</label>
            <input type="file" id="file-input">
        </div>
        <div id="file-selection-info">
            <span id="selected-file-name">Ingen fil vald</span>
            <button id="send-file-btn" disabled>Skicka vald fil</button>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const appContainer = document.getElementById('app-container');
            const dropZone = document.getElementById('drop-zone'); // NYTT: Referens till drop-zone
            const myIdSpan = document.getElementById('my-id'), copyIdBtn = document.getElementById('copy-id-btn');
            const peerIdInput = document.getElementById('peer-id-input'), connectBtn = document.getElementById('connect-btn');
            const statusDiv = document.getElementById('status');
            const videoContainer = document.getElementById('video-container'), localVideo = document.getElementById('local-video'), remoteVideo = document.getElementById('remote-video');
            const startCallBtn = document.getElementById('start-call-btn'), endCallBtn = document.getElementById('end-call-btn');
            const chatLog = document.getElementById('chat-log'), messageInput = document.getElementById('message-input'), sendBtn = document.getElementById('send-btn');
            const fileInput = document.getElementById('file-input'), sendFileBtn = document.getElementById('send-file-btn'), selectedFileName = document.getElementById('selected-file-name');
            
            let peer = null, dataConn = null, mediaConn = null, localStream = null, fileToSend = null;

            peer = new Peer(null, { debug: 2 });
            peer.on('open', (id) => { myIdSpan.textContent = id; copyIdBtn.disabled = false; updateStatus(`Väntar på att någon ska ansluta...`, 'waiting'); });
            peer.on('connection', (connection) => setupDataConnection(connection));
            peer.on('call', (call) => {
                navigator.mediaDevices.getUserMedia({ video: true, audio: true }).then(stream => {
                    localStream = stream; localVideo.srcObject = localStream; call.answer(stream); setupMediaConnection(call);
                }).catch(err => console.error('Kunde inte komma åt kamera/mikrofon: ', err));
            });
            peer.on('error', (err) => { console.error(err); updateStatus(`Fel: ${err.message}`, 'error'); });
            connectBtn.addEventListener('click', () => { if (peerIdInput.value.trim()) setupDataConnection(peer.connect(peerIdInput.value.trim())); });
            startCallBtn.addEventListener('click', () => {
                if (!dataConn) { alert("Anslut till en annan användare först!"); return; }
                navigator.mediaDevices.getUserMedia({ video: true, audio: true }).then(stream => {
                    localStream = stream; localVideo.srcObject = localStream; setupMediaConnection(peer.call(dataConn.peer, stream));
                }).catch(err => console.error('Kunde inte komma åt kamera/mikrofon: ', err));
            });
            endCallBtn.addEventListener('click', () => { if (mediaConn) mediaConn.close(); });
            copyIdBtn.addEventListener('click', () => navigator.clipboard.writeText(myIdSpan.textContent).then(() => {
                const originalText = copyIdBtn.textContent; copyIdBtn.textContent = 'Kopierat!';
                setTimeout(() => { copyIdBtn.textContent = originalText; }, 2000);
            }));

            sendBtn.addEventListener('click', sendMessage);
            messageInput.addEventListener('keypress', (e) => { if (e.key === 'Enter') sendMessage(); });
            fileInput.addEventListener('change', (e) => selectFile(e.target.files[0]));
            sendFileBtn.addEventListener('click', sendFile);

            // ÄNDRAT: Dra-och-släpp-logik med visuell feedback på den nya drop-zonen
            appContainer.addEventListener('dragover', (e) => { e.preventDefault(); dropZone.classList.add('drag-over'); });
            appContainer.addEventListener('dragleave', () => dropZone.classList.remove('drag-over'));
            appContainer.addEventListener('drop', (e) => {
                e.preventDefault(); dropZone.classList.remove('drag-over');
                if (e.dataTransfer.files.length > 0) {
                    selectFile(e.dataTransfer.files[0]);
                    if (e.dataTransfer.files.length > 1) addSystemMessage("Obs: Endast den första filen bifogades.");
                }
            });

            function selectFile(file) {
                if (!file || !dataConn) { if (!dataConn) { addSystemMessage("Anslut till en användare innan du väljer en fil."); } return; }
                fileToSend = file;
                const fileSizeKB = (fileToSend.size / 1024).toFixed(1);
                selectedFileName.textContent = `${fileToSend.name} (${fileSizeKB} KB)`;
                sendFileBtn.disabled = false;
            }

            function sendMessage() {
                if (dataConn && dataConn.open) {
                    const msg = messageInput.value.trim();
                    if (msg) { dataConn.send(msg); addMessage(msg, 'sent'); messageInput.value = ''; }
                }
            }
            
            function sendFile() {
                if (dataConn && dataConn.open && fileToSend) {
                    addSystemMessage(`Skickar fil: ${fileToSend.name}`);
                    dataConn.send({ type: 'file', file: fileToSend, fileName: fileToSend.name, fileType: fileToSend.type });
                    fileToSend = null; fileInput.value = '';
                    selectedFileName.textContent = 'Ingen fil vald'; sendFileBtn.disabled = true;
                }
            }

            function setupDataConnection(connection) {
                dataConn = connection;
                dataConn.on('open', () => { updateStatus(`Ansluten till ${dataConn.peer}.`, 'connected'); enableControls(); });
                dataConn.on('data', (data) => {
                    if (typeof data === 'string') { addMessage(data, 'received'); } 
                    else if (data.type === 'file') {
                        const blob = new Blob([data.file], { type: data.fileType });
                        const url = URL.createObjectURL(blob);
                        addSystemMessage(`Mottog en fil: <a href="${url}" download="${data.fileName}">Ladda ner ${data.fileName}</a>`);
                    }
                });
                dataConn.on('close', () => { updateStatus(`Anslutning bruten.`, 'error'); disableControls(); });
            }

            function setupMediaConnection(call) {
                mediaConn = call;
                videoContainer.style.display = 'block'; startCallBtn.style.display = 'none'; endCallBtn.style.display = 'inline-block';
                mediaConn.on('stream', (remoteStream) => remoteVideo.srcObject = remoteStream);
                mediaConn.on('close', () => {
                    videoContainer.style.display = 'none'; remoteVideo.srcObject = null; localVideo.srcObject = null;
                    if (localStream) localStream.getTracks().forEach(track => track.stop());
                    localStream = null; mediaConn = null;
                    startCallBtn.style.display = 'inline-block'; endCallBtn.style.display = 'none';
                    addSystemMessage('Videosamtal avslutat.');
                });
            }

            function addMessage(text, type) {
                const msgDiv = document.createElement('div'); msgDiv.className = `message ${type}`;
                msgDiv.textContent = text; chatLog.appendChild(msgDiv); chatLog.scrollTop = chatLog.scrollHeight;
            }
            function addSystemMessage(html) {
                const msgDiv = document.createElement('div'); msgDiv.className = 'message system';
                msgDiv.innerHTML = html; chatLog.appendChild(msgDiv); chatLog.scrollTop = chatLog.scrollHeight;
            }
            function updateStatus(message, type) {
                statusDiv.textContent = `Status: ${message}`; statusDiv.className = `status status-${type}`;
            }
            function enableControls() {
                messageInput.disabled = false; sendBtn.disabled = false;
                startCallBtn.disabled = false;
                peerIdInput.disabled = true; connectBtn.disabled = true;
            }
            function disableControls() {
                messageInput.disabled = true; sendBtn.disabled = true;
                startCallBtn.disabled = true; sendFileBtn.disabled = true;
                peerIdInput.disabled = false; connectBtn.disabled = false;
            }
        });
    </script>

</body>
</html>
